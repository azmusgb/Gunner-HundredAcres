
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: https://cdnjs.cloudflare.com https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data:; connect-src 'self'; font-src 'self' https://fonts.gstatic.com; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Baby Gunnar's Hundred Acre Wood Adventure</title>
    <meta content="A storybook-style Hundred Acre Wood adventure with a honey-catching game to celebrate Baby Gunnar."
          name="description">
    <meta content="#f4a944" name="theme-color">
    <meta content="light dark" name="color-scheme">
    <meta content="Baby Gunnar's Hundred Acre Wood Shower" property="og:title">
    <meta content="A sweet storybook and honey-catching game‚Äîread, play, and leave your wishes."
          property="og:description">
    <meta content="icons/icon.svg" property="og:image">
    <meta content="website" property="og:type">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&family=Patrick+Hand&display=swap"
          rel="stylesheet">

    <style>
        /* ==========================================================================
           BABY GUNNAR'S HUNDRED ACRE WOOD - REFACTORED DESIGN
           ========================================================================== */

        /* 1. COLOR SYSTEM - REFINED */
        :root {
            /* Primary Colors */
            --color-gold: #E8A427;
            --color-gold-light: #FFD89B;
            --color-gold-dark: #D89230;
            --color-red: #DC4D3F;
            --color-green: #5D7D4F;
            --color-green-light: #8B9D77;
            --color-blue: #6BA3D4;

            /* Neutrals */
            --color-parchment: #F6ECD6;
            --color-parchment-dark: #E8DCC5;
            --color-ink: #5A3A24;
            --color-ink-muted: #6B4A32;
            --color-white: #FFFCF7;
            --color-black: #1A1A1A;

            /* Layout */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2.5rem;
            --space-xl: 3rem;

            /* Typography */
            --font-body: 'EB Garamond', 'Georgia', serif;
            --font-heading: 'Patrick Hand', cursive;
            --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

            /* Effects */
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 16px 48px rgba(0, 0, 0, 0.16);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 999px;

            /* Spacing + Layout helpers */
            --tap-size: 56px;
            --edge-padding: clamp(0.75rem, 2vw, 1.5rem);
            --breakpoint-tablet: 768px;
            --breakpoint-mobile: 480px;

            /* Animation tuning */
            --motion-speed: 0.25s;
            --fps-cap: 60;

            /* Game Constants */
            --bear-speed: 260px;
            --jar-spawn-rate: 0.02;
            --bee-spawn-rate: 0.01;
            --game-time: 60;
        }

        /* 2. BASE RESET */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-body);
            font-size: 18px;
            line-height: 1.6;
            color: var(--color-ink);
            background: linear-gradient(135deg, #FFE8C8 0%, var(--color-parchment) 50%, #FFF5E6 100%);
            min-height: 100vh;
            padding: var(--space-md);
            overflow-x: hidden;
            position: relative;
        }

        /* 3. MODE INDICATOR (game/story view toggling hooks if needed later) */
        [data-mode="game"] .story-elements { display: none !important; }
        [data-mode="story"] .game-elements { display: none !important; }

        /* Instead of blurring everything, blur specific main areas when settings are open */
        body[data-mode="settings"] .hero-container,
        body[data-mode="settings"] .main-nav,
        body[data-mode="settings"] .content-container,
        body[data-mode="settings"] .site-footer {
            filter: blur(3px);
            pointer-events: none;
            user-select: none;
        }

        /* 4. LOADING STATE */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--color-parchment);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-gold-light);
            border-top: 4px solid var(--color-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-md);
        }

        @-webkit-keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 5. HERO SECTION */
        .hero-container {
            max-width: 1200px;
            margin: 0 auto var(--space-xl);
        }

        .hero-banner {
            background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-gold-light) 100%);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            position: relative;
        }

        .hero-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            object-position: center;
            display: block;
        }

        .hero-content {
            position: absolute;
            inset-inline: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.95), rgba(255, 248, 225, 0.85));
            padding: var(--space-lg);
            text-align: center;
            border-top: 3px solid var(--color-gold);
        }

        .hero-title {
            font-family: var(--font-heading);
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            color: var(--color-green);
            margin-bottom: var(--space-xs);
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: clamp(1rem, 2vw, 1.25rem);
            color: var(--color-ink-muted);
            max-width: 600px;
            margin: 0 auto;
        }

        /* 6. NAVIGATION */
        .main-nav {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin: 0 auto var(--space-lg);
            max-width: 1200px;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--color-gold);
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .nav-tracker {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
        }

        .nav-progress {
            flex: 1;
            height: 8px;
            background: var(--color-parchment-dark);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .nav-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-gold), var(--color-gold-dark));
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
            width: 0%;
        }

        .nav-buttons {
            display: flex;
            gap: var(--space-xs);
            overflow-x: auto;
            padding: var(--space-xs) 0;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-md);
            background: white;
            border: 2px solid var(--color-parchment-dark);
            border-radius: var(--radius-full);
            font-family: var(--font-ui);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-button:hover {
            border-color: var(--color-gold);
            transform: translateY(-2px);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #FFF9E6, #FFEDCC);
            border-color: var(--color-gold);
            font-weight: 600;
        }

        .nav-button-number {
            width: 28px;
            height: 28px;
            background: var(--color-gold);
            color: white;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* 7. CONTENT CONTAINER */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 500px;
        }

        .content-view {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .content-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 8. STORY VIEW */
        .story-view {
            background: linear-gradient(
                90deg,
                rgba(139, 111, 71, 0.8) 0%,
                rgba(193, 154, 107, 0.9) 5%,
                var(--color-parchment) 10%,
                var(--color-parchment) 90%,
                rgba(193, 154, 107, 0.9) 95%,
                rgba(139, 111, 71, 0.8) 100%
            );
            border-radius: 8px 24px 24px 8px;
            padding: 40px;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.6),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1),
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(139, 111, 71, 0.3);
            position: relative;
        }

        .story-view::before {
            content: '';
            position: absolute;
            left: 30px;
            top: 20px;
            bottom: 20px;
            width: 20px;
            background: linear-gradient(
                to right,
                rgba(139, 111, 71, 0.8) 0%,
                rgba(193, 154, 107, 0.9) 50%,
                rgba(139, 111, 71, 0.8) 100%
            );
            border-radius: 4px;
            box-shadow:
                inset 2px 0 4px rgba(0, 0, 0, 0.3),
                inset -2px 0 4px rgba(255, 255, 255, 0.2),
                5px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .story-content {
            position: relative;
            z-index: 2;
            background: linear-gradient(
                to bottom,
                var(--color-parchment) 0%,
                var(--color-parchment-dark) 100%
            );
            padding: 40px;
            border-radius: 4px;
            box-shadow:
                inset 0 0 0 1px rgba(139, 111, 71, 0.2),
                inset 0 0 40px rgba(139, 111, 71, 0.1),
                0 4px 20px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .story-header {
            text-align: center;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 3px double var(--color-gold);
        }

        .story-title {
            font-family: var(--font-heading);
            font-size: clamp(2rem, 4vw, 2.8rem);
            color: var(--color-green);
            margin-bottom: var(--space-sm);
        }

        .story-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: var(--space-md);
            text-align: justify;
        }

        .story-text:first-of-type::first-letter {
            font-size: 4rem;
            float: left;
            line-height: 0.8;
            margin: 0.1em 0.2em 0 0;
            color: var(--color-gold);
            font-weight: 600;
        }

        /* 9. GAME VIEW */
        .game-view {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-heavy);
            border: 6px solid var(--color-gold);
            position: relative;
            overflow: hidden;
        }

        .game-canvas-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .game-hud {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-sm);
            background: rgba(255, 255, 255, 0.9);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            border: 2px solid var(--color-gold);
        }

        .hud-item {
            text-align: center;
        }

        .hud-label {
            display: block;
            font-size: 0.9rem;
            color: var(--color-ink-muted);
            margin-bottom: var(--space-xs);
        }

        .hud-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-green);
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .game-btn {
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-full);
            font-family: var(--font-ui);
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .game-btn.primary {
            background: linear-gradient(135deg, var(--color-gold), var(--color-gold-dark));
            color: white;
        }

        .game-btn.secondary {
            background: var(--color-white);
            color: var(--color-green);
            border: 2px solid var(--color-gold);
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .mobile-controls {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            justify-content: space-between;
            padding: 0 var(--edge-padding);
        }

        .mobile-control-btn {
            width: var(--tap-size);
            height: var(--tap-size);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--color-gold);
            display: grid;
            place-items: center;
            font-size: 1.5rem;
            color: var(--color-green);
            touch-action: manipulation;
            box-shadow: var(--shadow-soft);
        }

        /* 10. REGISTRY VIEW */
        .registry-view {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-medium);
            border: 3px solid var(--color-gold-light);
        }

        .registry-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .registry-title {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            color: var(--color-green);
            margin-bottom: var(--space-sm);
        }

        .registry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .registry-card {
            background: linear-gradient(135deg, #FFFDF9, #FFFAF0);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            text-decoration: none;
            color: inherit;
            border: 2px solid var(--color-gold-light);
            transition: all 0.3s ease;
        }

        .registry-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
            border-color: var(--color-gold);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-md);
            text-align: center;
        }

        .card-title {
            font-family: var(--font-heading);
            font-size: 1.4rem;
            color: var(--color-green);
            margin-bottom: var(--space-sm);
        }

        /* 11. WISHES VIEW */
        .wishes-view {
            background: linear-gradient(135deg, #F8F4FF, #FFF8F0);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            border: 3px solid var(--color-gold);
        }

        .wishes-form {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--space-xl);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .form-label {
            font-family: var(--font-ui);
            font-weight: 600;
            color: var(--color-green);
        }

        .form-input {
            padding: var(--space-sm);
            border: 2px solid var(--color-parchment-dark);
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: vertical;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-gold);
            box-shadow: 0 0 0 3px rgba(232, 164, 39, 0.1);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--color-gold), var(--color-gold-dark));
            color: white;
            border: none;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-full);
            font-family: var(--font-ui);
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* 12. SETTINGS PANEL */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            transition: right 0.3s ease;
            padding: var(--space-lg);
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--color-gold-light);
        }

        .settings-title {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            color: var(--color-green);
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--color-ink-muted);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: grid;
            place-items: center;
            border-radius: 50%;
        }

        .close-settings:hover {
            background: var(--color-parchment);
        }

        .settings-section {
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-parchment-dark);
        }

        .settings-section-title {
            font-family: var(--font-ui);
            font-size: 1.1rem;
            color: var(--color-green);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            padding: var(--space-sm);
            background: var(--color-parchment);
            border-radius: var(--radius-sm);
            gap: var(--space-sm);
        }

        .settings-option span {
            font-family: var(--font-ui);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-gold);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
            flex-wrap: wrap;
        }

        /* Settings toggle button (gear) */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--color-gold);
            background: white;
            display: grid;
            place-items: center;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            z-index: 1002;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .settings-toggle i {
            color: var(--color-ink-muted);
            font-size: 1.2rem;
        }

        .settings-toggle:hover {
            background: #FFF9E6;
            transform: translateY(-1px) rotate(15deg);
            box-shadow: var(--shadow-medium);
        }

        /* 13. FOOTER */
        .site-footer {
            text-align: center;
            padding: var(--space-xl) 0;
            margin-top: var(--space-xl);
            border-top: 2px solid var(--color-gold-light);
            color: var(--color-ink-muted);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            flex-wrap: wrap;
            margin-top: var(--space-md);
        }

        .footer-btn {
            padding: var(--space-sm) var(--space-md);
            background: white;
            border: 2px solid var(--color-gold-light);
            border-radius: var(--radius-full);
            font-family: var(--font-ui);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .footer-btn:hover {
            background: var(--color-gold-light);
            transform: translateY(-2px);
        }

        /* 14. UTILITY CLASSES */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .game-instructions {
            margin-top: var(--space-lg);
            background: linear-gradient(135deg, #fff9ec, #fff3d9);
            border: 2px dashed var(--color-gold);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-soft);
        }

        .game-instructions summary {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .dialog-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: grid;
            place-items: center;
            z-index: 1200;
        }

        .dialog {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy);
            max-width: 380px;
            width: calc(100% - 2 * var(--edge-padding));
            border: 3px solid var(--color-gold);
        }

        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .fallback-alert {
            background: #fff4f4;
            color: var(--color-red);
            border: 2px solid var(--color-red);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }

        .orientation-tip {
            position: fixed;
            bottom: var(--space-sm);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            display: none;
            z-index: 1100;
        }

        /* 15. RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            body {
                padding: var(--space-sm);
                font-size: 16px;
            }

            .hero-image {
                height: 300px;
            }

            .story-view {
                padding: 20px;
            }

            .story-content {
                padding: 20px;
            }

            .game-hud {
                grid-template-columns: repeat(3, 1fr);
            }

            .mobile-controls {
                display: flex;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }

            .game-controls {
                flex-wrap: wrap;
            }

            .nav-buttons {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .hero-image {
                height: 250px;
            }

            .hero-title {
                font-size: 2rem;
            }

            .game-hud {
                grid-template-columns: repeat(2, 1fr);
            }

            .registry-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 16. DARK MODE */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-parchment: #2A241C;
                --color-parchment-dark: #1A1610;
                --color-ink: #E8DCC5;
                --color-ink-muted: #C8B9A0;
                --color-white: #1A1A1A;
            }

            body {
                background: linear-gradient(135deg, #1A1610 0%, #2A241C 50%, #3A342C 100%);
            }

            .story-view {
                background: linear-gradient(
                    90deg,
                    rgba(74, 62, 42, 0.8) 0%,
                    rgba(109, 92, 64, 0.9) 5%,
                    var(--color-parchment) 10%,
                    var(--color-parchment) 90%,
                    rgba(109, 92, 64, 0.9) 95%,
                    rgba(74, 62, 42, 0.8) 100%
                );
            }

            .main-nav,
            .registry-view,
            .game-view,
            .wishes-view,
            .settings-panel,
            .wishes-form {
                background: #2A241C;
                color: var(--color-ink);
            }
        }
    </style>
</head>
<body data-mode="story">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Entering the Hundred Acre Wood...</p>
    </div>



    <!-- Hero Section -->
    <header class="hero-container">
        <div class="hero-banner">
            <img src="Images/Characters/honey-bear.png" alt="Baby Gunnar's Hundred Acre Wood" class="hero-image">
            <div class="hero-content">
                <h1 class="hero-title">Baby Gunnar's Hundred Acre Wood Shower</h1>
                <p class="hero-subtitle">A storybook celebration with Pooh &amp; friends</p>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav" aria-label="Story chapters">
        <div class="nav-tracker">
            <span>Progress:</span>
            <div class="nav-progress">
                <div class="nav-progress-fill" id="navProgress"></div>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="nav-button active" data-view="story" data-chapter="1">
                <span class="nav-button-number">1</span>
                <span>Welcome</span>
            </button>
            <button class="nav-button" data-view="game" data-chapter="2">
                <span class="nav-button-number">2</span>
                <span>Honey Game</span>
            </button>
            <button class="nav-button" data-view="registry" data-chapter="3">
                <span class="nav-button-number">3</span>
                <span>Registry</span>
            </button>
            <button class="nav-button" data-view="wishes" data-chapter="4">
                <span class="nav-button-number">4</span>
                <span>Wishes</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="content-container">
        <!-- Story View -->
        <section class="content-view story-view active" id="storyView" aria-label="Story view">
            <div class="story-content">
                <header class="story-header">
                    <h2 class="story-title">A Special Day in the Hundred Acre Wood</h2>
                    <p>Chapter One: An Invitation to Celebrate</p>
                </header>
                <p class="story-text">One fine spring day, in a corner of the Hundred Acre Wood where the sun shines warmly through the trees and the flowers bloom in cheerful colors, something wonderful was happening. All the forest friends were gathering, for there was to be a celebration unlike any other.</p>
                <p class="story-text">"What sort of celebration?" you might ask. Well, it was the very best sort‚Äîthe kind that welcomes a new little friend to the world. A baby boy named Gunnar James was soon to arrive, and everyone in the Hundred Acre Wood wanted to share in the joy.</p>
                <p class="story-text">Winnie the Pooh, being a Bear of Very Little Brain but a Very Big Heart, knew that the most important thing for any celebration was honey. And not just a little honey, but lots and lots of it. After all, welcoming Baby Gunnar was a Very Important Matter.</p>
                <p class="story-text">"But first," thought Pooh, looking up at his honey pots on the high shelf, "we'll need to gather more honey. Won't you help?"</p>
            </div>
        </section>

        <!-- Game View -->
        <section class="content-view game-view" id="gameView" aria-label="Honey game view">
            <div class="game-canvas-container">
                <canvas id="gameCanvas"></canvas>
                <div class="mobile-controls">
                    <button class="mobile-control-btn" id="mobileLeft" aria-label="Move left"><i class="fas fa-arrow-left"></i></button>
                    <button class="mobile-control-btn" id="mobilePause" aria-label="Pause game"><i class="fas fa-pause"></i></button>
                    <button class="mobile-control-btn" id="mobileRight" aria-label="Move right"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="game-hud" aria-label="Game statistics">
                <div class="hud-item">
                    <span class="hud-label">Score</span>
                    <span class="hud-value" id="scoreValue">0</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Best</span>
                    <span class="hud-value" id="bestValue">0</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Time</span>
                    <span class="hud-value" id="timeValue">60</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Lives</span>
                    <span class="hud-value" id="livesValue">3</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Streak</span>
                    <span class="hud-value" id="streakValue">0</span>
                </div>
            </div>

            <div class="game-controls" aria-label="Game controls">
                <button class="game-btn primary" id="startGame">
                    <i class="fas fa-play"></i> Start Game
                </button>
                <button class="game-btn secondary" id="pauseGame">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="game-btn secondary" id="restartGame">
                    <i class="fas fa-redo"></i> Restart
                </button>
            </div>

            <details class="game-instructions">
                <summary>How to play</summary>
                <ul style="margin-top: var(--space-sm); padding-left: var(--space-md);">
                    <li>Use ‚Üê ‚Üí (or A/D) on desktop, or the big honey buttons on mobile to move.</li>
                    <li>Catch jars to score. Gold = big points, blue jars grant a shielded life.</li>
                    <li>Avoid bees. Your streak and the timer increase difficulty as you improve.</li>
                    <li>Tap Pause to confirm pausing; resume to keep your flow.</li>
                </ul>
            </details>
        </section>

        <!-- Registry View -->
        <section class="content-view registry-view" id="registryView" aria-label="Registry view">
            <header class="registry-header">
                <h2 class="registry-title">Baby Gunnar's Registry</h2>
                <p>Your presence is the greatest present, but if you'd like to contribute to his woodland adventures:</p>
            </header>

            <div class="registry-grid">
                <a href="https://my.babylist.com/lea-hardesty" class="registry-card" target="_blank" rel="noopener">
                    <div class="card-icon">üéØ</div>
                    <h3 class="card-title">Babylist Registry</h3>
                    <p>For everyday essentials and nursery items</p>
                </a>

                <div class="registry-card">
                    <div class="card-icon">üíù</div>
                    <h3 class="card-title">Gift Ideas</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li>üìö Board books &amp; stories</li>
                        <li>üß∏ Woodland-themed clothing</li>
                        <li>üõèÔ∏è Soft blankets &amp; swaddles</li>
                        <li>üë∂ Diapers &amp; essentials</li>
                    </ul>
                </div>
            </div>

            <div style="margin-top: var(--space-xl); text-align: center;">
                <h3>Nursery Details</h3>
                <p>Theme: Hundred Acre Wood Adventures ‚Ä¢ Colors: Honey gold, Pooh red, sage green</p>
                <p>Location: Arizona ‚Ä¢ Expected: Late August 2025</p>
            </div>
        </section>

        <!-- Wishes View -->
        <section class="content-view wishes-view" id="wishesView" aria-label="Guest wishes view">
            <header class="registry-header">
                <h2 class="registry-title">Share Your Wishes</h2>
                <p>Leave wisdom, well-wishes, or favorite childhood memories for Gunnar's storybook</p>
            </header>

            <form class="wishes-form" id="wishesForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="guestName" class="form-label">Your Name</label>
                        <input type="text" id="guestName" class="form-input" placeholder="How should we call you?" required>
                    </div>
                    <div class="form-group">
                        <label for="guestRelation" class="form-label">Your Relation</label>
                        <select id="guestRelation" class="form-input">
                            <option value="">Choose one...</option>
                            <option value="family">Family</option>
                            <option value="friend">Friend</option>
                            <option value="colleague">Colleague</option>
                            <option value="woodland-friend">Woodland Friend</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="wishMessage" class="form-label">Your Message</label>
                    <textarea id="wishMessage" class="form-input" rows="4" placeholder="What wisdom or wishes would you like to share with Baby Gunnar?..." required></textarea>
                    <div style="text-align: right; font-size: 0.9rem; color: var(--color-ink-muted); margin-top: var(--space-xs);">
                        <span id="charCount">0</span>/500 characters
                    </div>
                </div>

                <div style="text-align: center; margin-top: var(--space-lg);">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-book"></i> Add to Gunnar's Storybook
                    </button>
                </div>
            </form>

            <div id="wishesDisplay" style="margin-top: var(--space-xl);">
                <h3 style="text-align: center; margin-bottom: var(--space-lg);">Wishes from the Wood</h3>
                <!-- Wishes will appear here -->
            </div>
        </section>
    </main>
<!-- Settings Panel -->
<div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
        <h2 class="settings-title">Settings</h2>
        <button class="close-settings" id="closeSettings" aria-label="Close settings">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="settings-section">
        <h3 class="settings-section-title"><i class="fas fa-gamepad"></i> Game Settings</h3>
        
        <div class="settings-option">
            <span>Difficulty</span>
            <select id="difficultySelect">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
                <option value="expert">Expert</option>
            </select>
        </div>
        
        <div class="settings-option">
            <span>Bear Speed</span>
            <input type="range" id="sensitivitySlider" min="100" max="400" value="260">
        </div>
    </div>
    
    <div class="settings-section">
        <h3 class="settings-section-title"><i class="fas fa-volume-up"></i> Audio</h3>
        
        <div class="settings-option">
            <span>Background Music</span>
            <label class="toggle-switch">
                <input type="checkbox" id="musicToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="settings-option">
            <span>Sound Effects</span>
            <label class="toggle-switch">
                <input type="checkbox" id="sfxToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="settings-option">
            <span>Volume</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="80">
        </div>
    </div>
    
    <div class="settings-section">
        <h3 class="settings-section-title"><i class="fas fa-magic"></i> Visual Effects</h3>
        
        <div class="settings-option">
            <span>Particles</span>
            <label class="toggle-switch">
                <input type="checkbox" id="particlesToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="settings-option">
            <span>Animations</span>
            <label class="toggle-switch">
                <input type="checkbox" id="animationsToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>
    
    <div class="settings-actions">
        <button class="game-btn secondary" id="resetSettings">Reset to Defaults</button>
        <button class="game-btn primary" id="saveSettings">Save Settings</button>
    </div>
</div>

<!-- Settings Toggle Button -->
<button class="settings-toggle" id="settingsToggle" aria-label="Open settings">
    <i class="fas fa-cog"></i>
</button>

<!-- Pause confirmation dialog -->
<div class="dialog-backdrop hidden" id="pauseDialog" role="dialog" aria-modal="true" aria-labelledby="pauseTitle">
    <div class="dialog">
        <h3 id="pauseTitle" style="margin-bottom: var(--space-sm);">Pause the game?</h3>
        <p>We will stop the timer and bees until you resume.</p>
        <div class="dialog-actions">
            <button class="game-btn secondary" id="cancelPause">Keep playing</button>
            <button class="game-btn primary" id="confirmPause">Pause now</button>
        </div>
    </div>
</div>

<div class="orientation-tip" id="orientationTip">Rotate for a wider playfield</div>
<div id="errorBoundary" class="fallback-alert hidden" role="alert">Something went wrong. We restored the last safe state.</div>
    <!-- Footer -->
    <footer class="site-footer">
        <p>Made with üíô and üçØ for Baby Gunnar's special day</p>
        <div class="footer-links">
            <button class="footer-btn" id="printBtn"><i class="fas fa-print"></i> Print</button>
            <button class="footer-btn" id="shareBtn"><i class="fas fa-share-alt"></i> Share</button>
            <button class="footer-btn" id="toggleMusicBtn"><i class="fas fa-music"></i> Music</button>
        </div>
    </footer>

    <!-- Audio Elements -->
    <audio id="bgMusic" loop></audio>
    <audio id="honeySound" preload="auto" src="data:audio/wav;base64,UklGRggHAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YeQGAAAAANsCswWDCEYL+g2ZECITjhXdFwkaEBzwHaUfLSGGIq4joyRkJfAlRiZlJk8mASZ+JcUk2CO5Imgh5x85HmAcXxo4GO8VhxMDEWcOtwv1CCcGUQN1AJr9wfrw9yr1dPLR70Xt0+qA6E7mQORa4p7gD9+u3X/cgdu42iPaxNmc2arZ79lp2hrb/tsW3V/e2N9/4VHjTOVt57DpFOyU7izx2vOY9mX5OvwV//ABygSdB2UKHg3ED1QSyhQjF1oZbhtaHR0ftCAcIlQjWiQsJcklMCZhJlwmICauJQYlKiQbI9khaCDIHv0cCBvtGK8WUBTVEUAPlgzZCQ8HOwRgAYX+q/vX+A32UfOn8BTumes86f/m5eTy4ijhit8a3tvczdvz2k3a3dmj2aDZ09k82tvar9u23PDdWt/y4LfipeS65vPoTOvD7VTw+/K19X34UPsq/gUB4AO2BoEJQAzsDoQRAxRlFqgYxxrBHJEeNiCuIfUiCyTuJJwlFSZXJmQmOSbYJUIldyR3I0Yi4yBSH5UdrRueGWsXFhWkEhcQcw28CvYHJAVLAnD/lfy++fH2MPSA8eXuYuz76bPnjuWO47fhCuCL3jzdHtwz23za+9mw2ZvZvNkU2qLaZdtc3Ibd4N5q4CHiAuQK5jjoiOr27H/vH/LT9Jf3Z/o//RoA9gLNBZ0IYAsTDrEQOROkFfIXHRojHAEetB86IZEityOrJGol9CVIJmYmTSb9JXglviTPI60iWiHYHykeThxMGiQY2hVwE+sQTg6dC9sIDQY2A1sAgP2n+tb3EfVb8rnvLu296mvoOuYu5Enij+AB36LddNx527HaH9rC2ZzZrNny2W/aIdsH3CHdbN7n34/hY+Nf5YHnxukr7KvuRfHz87L2f/lV/DD/CwLkBLcHfgo3DdwPbBLhFDgXbhmAG2wdLR/CICgiXiNiJDIlzSUzJmImWyYdJqkl/yQhJBAjzSFZILge6xz1GtkYmRY6FL0RKA99DMAJ9QYgBEYBav6Q+7348/U484/w/O2D6ybp6ubS5OHiGOF83w7e0NzE2+zaSNra2aLZodnW2UHa4tq428Hc/N1o3wLhyOK35M7mCOlj69vtbPAU88/1mPhr+0X+IAH7A9AGmwlZDAUPnBEaFHsWvBjaGtIcoR5FILshACMUJPUkoSUYJlkmYyY3JtQlOyVuJG0jOiLWIEMfhB2bG4sZVhcAFY0S/w9aDaMK3AcKBTECVv96/KT51/YX9Gjxze5L7OXpnud65XzjpuH8337eMd0V3Czbd9r32a7Zm9m/2RnaqNpt22bckt3u3nngMeIU5B7mTeie6g3tl+848u30sfeC+lr9NQAQA+gFtwh5CysOyRBQE7oVBhgwGjUcER7DH0ghnSLBI7MkcCX4JUomZiZLJvklciW2JMUjoiJNIckfGB48HDgaDxjEFVkT0xA2DoQLwQjzBRwDQABl/Y36vPf39ELyoe8W7afqVugm5hzkOeKA4PTel91q3HHbq9oa2sDZm9mt2fbZdNoo2xHcLN153vXfn+F143Lllufc6UHsw+5d8Qz0zPaZ+W/8Sv8mAv8E0QeYClAN9Q+DEvcUTReCGZMbfR08H9AgNSJpI2skOSXSJTUmYyZZJhkmpCX4JBgkBSPAIUsgqB7aHOIaxRiEFiMUphEPD2MMpgnbBgYEKwFQ/nb7o/ja9R/zd/Dl7WzrEenW5r/kz+IJ4W7fAd7F3Lvb5dpD2tfZodmi2dnZRtrp2sDbzNwJ3nbfEuHZ4srk4uYd6Xnr8u2F8C3z6PWy+IX7X/47ARUE6ga1CXIMHQ+zETAUkBbQGO0a5ByxHlMgxyELIx0k/CSnJRsmWiZiJjQmzyU1JWYkYyMuIsggMx9zHYgbdxlBF+oUdRLnD0ENiQrCB+8EFgI7/2D8ivm99v7zT/G17jTsz+mK52flauOW4e3fcd4m3QvcJNtx2vTZrNmb2cHZHdqv2nXbcNyd3fzeieBC4ibkMuZi6LTqJO2v71HyBvXL95z6dP1PACsDAgbQCJILRA7hEGcT0BUbGEQaRxwiHtIfVSGoIssjuiR2JfwlTCZmJkkm9SVsJa4kvCOWIkAhuh8IHiocJRr6F64VQhO8EB0OaguoCNgFAQMlAEr9cvqi9970KfKJ7//skepB6BPmCeQo4nHg5t6L3WDcadul2hbavdmb2a/Z+dl62jDbGtw33YbeBOCw4YbjheWq5/LpWOzb7nbxJfTm9rP5ivxl/0ACGQXrB7EKaQ0NEJoSDRViF5YZpRuOHUwf3iBBInMjcyQ/JdclOCZjJlgmFiaeJfEkDyT6IrMhPCCYHsgczxqwGG4WDBSOEfcOSgw="></audio>
    <audio id="pageSound" preload="auto" src="data:audio/wav;base64,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"></audio>
    <audio id="beeSound" preload="auto" src="data:audio/wav;base64,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"></audio>

    <script>
        // ==========================================================================
        // BABY SHOWER APPLICATION - REFACTORED ARCHITECTURE
        // ==========================================================================

        const SafeEvents = {
            stack: [],
            add(target, type, handler, options) {
                if (!target) return;
                target.addEventListener(type, handler, options);
                this.stack.push({ target, type, handler, options });
            },
            removeAll(filterFn) {
                this.stack = this.stack.filter(listener => {
                    const shouldRemove = filterFn ? filterFn(listener) : true;
                    if (shouldRemove) {
                        const { target, type, handler, options } = listener;
                        target.removeEventListener(type, handler, options);
                    }
                    return !shouldRemove;
                });
            }
        };

        const withErrorBoundary = (fn, fallback) => {
            try {
                return fn();
            } catch (error) {
                console.error(error);
                const banner = document.getElementById('errorBoundary');
                if (banner) {
                    banner.classList.remove('hidden');
                    banner.textContent = 'Something went wrong. We restored the last safe state.';
                    setTimeout(() => banner.classList.add('hidden'), 4000);
                }
                if (fallback) fallback(error);
            }
        };

        // STATE MANAGEMENT
        class AppState {
            constructor() {
                this.state = {
                    currentView: 'story',
                    currentChapter: 1,
                    mode: 'story', // 'story', 'game', 'settings'
                    game: {
                        score: 0,
                        best: 0,
                        running: false,
                        paused: false,
                        timeLeft: 60,
                        lives: 3,
                        streak: 0
                    },
                    settings: {
                        difficulty: 'medium',
                        music: true,
                        sfx: true,
                        volume: 80,
                        particles: true,
                        animations: true,
                        sensitivity: 260
                    },
                    wishes: []
                };
                this.listeners = [];
                this.load();
            }

            set(path, value) {
                const paths = path.split('.');
                if (paths.length === 1 && path === 'settings') {
                    this.state.settings = { ...this.state.settings, ...value };
                } else {
                    let obj = this.state;
                    for (let i = 0; i < paths.length - 1; i++) {
                        obj = obj[paths[i]];
                    }
                    obj[paths[paths.length - 1]] = value;
                }
                this.save();
                this.notify(path, value);
            }

            get(path) {
                return path.split('.').reduce((obj, key) => obj?.[key], this.state);
            }

            on(path, callback) {
                this.listeners.push({ path, callback });
            }

            notify(path, value) {
                this.listeners.forEach(({ path: listenerPath, callback }) => {
                    if (listenerPath === '*' || path.startsWith(listenerPath)) {
                        callback(path, value);
                    }
                });
            }

            save() {
                try {
                    localStorage.setItem('babyShowerState', JSON.stringify({
                        settings: this.state.settings,
                        game: { best: this.state.game.best },
                        wishes: this.state.wishes
                    }));
                } catch (e) {
                    console.error('Failed to save state:', e);
                }
            }

            load() {
                try {
                    const saved = localStorage.getItem('babyShowerState');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.state.settings = { ...this.state.settings, ...parsed.settings };
                        this.state.game.best = parsed.game?.best || 0;
                        this.state.wishes = parsed.wishes || [];
                    }
                } catch (e) {
                    console.error('Failed to load state:', e);
                }
            }
        }

        // EVENT BUS FOR COMPONENT COMMUNICATION (hookable if needed)
        class EventBus {
            constructor() {
                this.events = {};
            }

            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(callback => callback(data));
                }
            }

            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            }

            off(event, callback) {
                if (this.events[event]) {
                    this.events[event] = this.events[event].filter(cb => cb !== callback);
                }
            }
        }

        // APPLICATION ORCHESTRATOR
        class BabyShowerApp {
            constructor() {
                this.state = new AppState();
                this.events = new EventBus();
                this.components = {};
                this.initialized = false;
            }

            async init() {
                if (this.initialized) return;

                try {
                    // Initialize components in a safe order
                    this.components.navigation = new Navigation(this);
                    this.components.views      = new ViewManager(this);
                    this.components.game       = new HoneyGame(this);
                    this.components.audio      = new AudioManager(this);      // audio before settings
                    this.components.settings   = new SettingsManager(this);
                    this.components.wishes     = new WishesManager(this);

                    // Set up event listeners
                    this.setupEventListeners();

                    // Update UI with initial state
                    this.updateUI();

                    // Hide loading overlay
                    setTimeout(() => {
                        const overlay = document.getElementById('loadingOverlay');
                        if (overlay) overlay.classList.add('hidden');
                        this.initialized = true;
                    }, 500);
                } catch (err) {
                    console.error('Initialization error:', err);
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) overlay.classList.add('hidden');
                }
            }

            setupEventListeners() {
                // Global keyboard handling
                SafeEvents.add(document, 'keydown', (e) => {
                    const mode = this.state.get('mode');

                    if (mode === 'game') {
                        this.components.game.handleKeyDown(e);
                    } else if (mode === 'story') {
                        if (e.key === 'ArrowRight') this.nextChapter();
                        if (e.key === 'ArrowLeft') this.prevChapter();
                    }

                    // Escape closes settings
                    if (e.key === 'Escape' && mode === 'settings') {
                        this.closeSettings();
                    }
                });

                SafeEvents.add(document, 'keyup', (e) => {
                    if (this.state.get('mode') === 'game') {
                        this.components.game.handleKeyUp(e);
                    }
                });

                // Mobile orientation
                SafeEvents.add(window, 'orientationchange', () => {
                    setTimeout(() => this.components.game?.resize(), 100);
                    this.components.game?.showOrientationTip();
                });

                // Window resize
                SafeEvents.add(window, 'resize', () => {
                    this.components.game?.resize();
                });
            }

            updateUI() {
                const view = this.state.get('currentView');
                const chapter = this.state.get('currentChapter');

                // Update navigation
                this.components.navigation.update(chapter);

                // Update view
                this.components.views.show(view);

                // Update mode
                document.body.setAttribute('data-mode', this.state.get('mode'));
            }

            setView(view, chapter = 1) {
                const leavingGame = this.state.get('currentView') === 'game' && view !== 'game';
                this.state.set('currentView', view);
                this.state.set('currentChapter', chapter);
                this.state.set('mode', view === 'game' ? 'game' : 'story');
                if (leavingGame) {
                    this.components.game.stop();
                    this.components.game.detachControls();
                }
                this.updateUI();
            }

            nextChapter() {
                const chapters = ['story', 'game', 'registry', 'wishes'];
                const current = this.state.get('currentView');
                const index = chapters.indexOf(current);

                if (index < chapters.length - 1) {
                    this.setView(chapters[index + 1], index + 2);
                }
            }

            prevChapter() {
                const chapters = ['story', 'game', 'registry', 'wishes'];
                const current = this.state.get('currentView');
                const index = chapters.indexOf(current);

                if (index > 0) {
                    this.setView(chapters[index - 1], index);
                }
            }

            openSettings() {
                this.state.set('mode', 'settings');
                this.components.settings.show();
            }

            closeSettings() {
                const fallbackMode = this.state.get('currentView') === 'game' ? 'game' : 'story';
                this.state.set('mode', fallbackMode);
                this.components.settings.hide();
            }
        }

        // NAVIGATION COMPONENT
        class Navigation {
            constructor(app) {
                this.app = app;
                this.navButtons = document.querySelectorAll('.nav-button');
                this.progressFill = document.getElementById('navProgress');
                this.init();
            }

            init() {
                this.navButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const view = btn.dataset.view;
                        const chapter = parseInt(btn.dataset.chapter, 10);
                        this.app.setView(view, chapter);
                    });
                });
            }

            update(chapter) {
                const totalChapters = 4;
                const progress = (chapter / totalChapters) * 100;
                this.progressFill.style.width = `${progress}%`;

                this.navButtons.forEach(btn => {
                    const btnChapter = parseInt(btn.dataset.chapter, 10);
                    btn.classList.toggle('active', btnChapter === chapter);
                });
            }
        }

        // VIEW MANAGER COMPONENT
        class ViewManager {
            constructor(app) {
                this.app = app;
                this.views = {
                    story: document.getElementById('storyView'),
                    game: document.getElementById('gameView'),
                    registry: document.getElementById('registryView'),
                    wishes: document.getElementById('wishesView')
                };
            }

            show(view) {
                withErrorBoundary(() => {
                    Object.values(this.views).forEach(v => v?.classList.remove('active'));

                    if (this.views[view]) {
                        this.views[view].classList.add('active');

                        if (view === 'game') {
                            this.app.components.game.init();
                            this.app.components.game.attachControls();
                        }
                    }
                });
            }
        }

        // GAME COMPONENT
        class HoneyGame {
            constructor(app) {
                this.app = app;
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.container = document.querySelector('.game-canvas-container');

                this.gameObjects = {
                    bear: { x: 0, y: 0, width: 40, height: 60, vx: 0 },
                    jars: [],
                    bees: [],
                    particles: []
                };

                this.scale = 1;
                this.virtualWidth = 800;
                this.virtualHeight = 450;

                this.keys = { left: false, right: false };
                this.lastTime = 0;
                this.lastRenderTime = 0;
                this.frameInterval = 1000 / Math.max(30, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fps-cap')) || 60);
                this.gameLoopId = null;
                this.controlListeners = [];
                this.controlsAttached = false;
                this.backgroundCanvas = document.createElement('canvas');
                this.backgroundCtx = this.backgroundCanvas.getContext('2d');
                this.hitFlash = 0;
                this.missFlash = 0;
                this.active = false;
                this.boundLoop = this.loop.bind(this);
                this.pauseDialog = document.getElementById('pauseDialog');

                this.initElements();
            }

            initElements() {
                // Game controls
                this.bindControl(document.getElementById('startGame'), 'click', () => this.start());
                this.bindControl(document.getElementById('pauseGame'), 'click', () => this.requestPause());
                this.bindControl(document.getElementById('restartGame'), 'click', () => this.reset());

                // Mobile controls
                const mobileLeft = document.getElementById('mobileLeft');
                const mobileRight = document.getElementById('mobileRight');
                const mobilePause = document.getElementById('mobilePause');

                this.bindControl(mobileLeft, 'touchstart', (e) => { e.preventDefault(); this.keys.left = true; }, { passive: false });
                this.bindControl(mobileLeft, 'touchend', (e) => { e.preventDefault(); this.keys.left = false; }, { passive: false });
                this.bindControl(mobileRight, 'touchstart', (e) => { e.preventDefault(); this.keys.right = true; }, { passive: false });
                this.bindControl(mobileRight, 'touchend', (e) => { e.preventDefault(); this.keys.right = false; }, { passive: false });
                this.bindControl(mobilePause, 'click', () => this.requestPause());

                this.bindControl(document.getElementById('confirmPause'), 'click', () => this.pause());
                this.bindControl(document.getElementById('cancelPause'), 'click', () => this.resume());
            }

            bindControl(target, type, handler, options) {
                if (!target) return;
                const record = { target, type, handler, options };
                target.addEventListener(type, handler, options);
                this.controlListeners.push(record);
                SafeEvents.stack.push(record);
            }

            init() {
                this.resize();
                this.resetGameState();
                this.updateHUD();
                this.attachControls();
            }

            attachControls() {
                if (this.controlsAttached) return;
                this.controlsAttached = true;
                this.bindControl(document, 'visibilitychange', () => {
                    if (document.hidden) this.pause();
                });
                this.bindControl(window, 'blur', () => this.requestPause());
                this.bindControl(window, 'resize', () => this.resize());
            }

            detachControls() {
                if (!this.controlsAttached) return;
                SafeEvents.removeAll(listener => this.controlListeners.includes(listener));
                this.controlListeners = [];
                this.controlsAttached = false;
            }

            resize() {
                const rect = this.container.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;

                this.scale = Math.min(this.canvas.width / 800, this.canvas.height / 450) || 1;
                this.virtualWidth = this.canvas.width / this.scale;
                this.virtualHeight = this.canvas.height / this.scale;

                this.gameObjects.bear.x = this.virtualWidth / 2;
                this.gameObjects.bear.y = this.virtualHeight * 0.85;
                this.backgroundCanvas.width = this.canvas.width;
                this.backgroundCanvas.height = this.canvas.height;
                this.drawBackground(true);
                this.showOrientationTip();
            }

            resetGameState() {
                const state = this.app.state.get('game');
                state.score = 0;
                state.timeLeft = this.getTimeLimit();
                state.lives = this.getLives();
                state.streak = 0;

                this.gameObjects.jars = [];
                this.gameObjects.bees = [];
                this.gameObjects.particles = [];

                this.updateHUD();
            }

            getDifficultySettings() {
                const difficulty = this.app.state.get('settings.difficulty');
                const settings = {
                    easy:   { jarSpawn: 0.015, jarSpeed: 100, beeSpawn: 0.008, beeSpeed: 80,  time: 90, lives: 4 },
                    medium: { jarSpawn: 0.02,  jarSpeed: 150, beeSpawn: 0.01,  beeSpeed: 100, time: 60, lives: 3 },
                    hard:   { jarSpawn: 0.025, jarSpeed: 180, beeSpawn: 0.015, beeSpeed: 120, time: 45, lives: 2 },
                    expert: { jarSpawn: 0.03,  jarSpeed: 200, beeSpawn: 0.02,  beeSpeed: 150, time: 30, lives: 1 }
                };
                return settings[difficulty] || settings.medium;
            }

            getTimeLimit() {
                return this.getDifficultySettings().time;
            }

            getLives() {
                return this.getDifficultySettings().lives;
            }

            start() {
                const state = this.app.state.get('game');
                if (!state.running) {
                    this.resetGameState();
                }
                state.running = true;
                state.paused = false;
                this.active = true;
                this.lastTime = performance.now();
                this.lastRenderTime = this.lastTime;
                cancelAnimationFrame(this.gameLoopId);
                this.gameLoopId = requestAnimationFrame(this.boundLoop);
            }

            requestPause() {
                const state = this.app.state.get('game');
                if (!state.running || state.paused) return;
                this.pauseDialog.classList.remove('hidden');
                document.getElementById('confirmPause').focus();
            }

            pause() {
                const state = this.app.state.get('game');
                if (!state.running) return;
                state.paused = true;
                cancelAnimationFrame(this.gameLoopId);
                this.pauseDialog.classList.add('hidden');
            }

            resume() {
                const state = this.app.state.get('game');
                if (!state.running) return;
                this.pauseDialog.classList.add('hidden');
                state.paused = false;
                this.lastTime = performance.now();
                this.lastRenderTime = this.lastTime;
                this.gameLoopId = requestAnimationFrame(this.boundLoop);
            }

            reset() {
                this.resetGameState();
                if (this.app.state.get('game.running')) {
                    this.start();
                }
            }

            loop(timestamp) {
                if (!this.app.state.get('game.running') || this.app.state.get('game.paused')) return;
                if (document.body.getAttribute('data-mode') !== 'game') {
                    this.stop();
                    return;
                }

                const elapsed = timestamp - this.lastRenderTime;
                if (elapsed < this.frameInterval) {
                    this.gameLoopId = requestAnimationFrame(this.boundLoop);
                    return;
                }

                const dt = Math.min(0.05, (timestamp - this.lastTime) / 1000);
                this.lastTime = timestamp;
                this.lastRenderTime = timestamp;

                this.update(dt);
                this.render();

                if (this.app.state.get('game.running') && !this.app.state.get('game.paused')) {
                    this.gameLoopId = requestAnimationFrame(this.boundLoop);
                }
            }

            stop() {
                this.app.state.set('game.running', false);
                this.app.state.set('game.paused', false);
                cancelAnimationFrame(this.gameLoopId);
                this.active = false;
            }

            update(dt) {
                const state = this.app.state.get('game');

                // Update time
                state.timeLeft -= dt;
                if (state.timeLeft <= 0) {
                    state.timeLeft = 0;
                    this.gameOver();
                    return;
                }

                // Update bear position
                const sensitivity = this.app.state.get('settings.sensitivity');
                if (this.keys.left) this.gameObjects.bear.vx = -sensitivity;
                else if (this.keys.right) this.gameObjects.bear.vx = sensitivity;
                else this.gameObjects.bear.vx = 0;

                this.gameObjects.bear.x += this.gameObjects.bear.vx * dt;
                this.gameObjects.bear.x = Math.max(20, Math.min(this.virtualWidth - 20, this.gameObjects.bear.x));

                // Spawn objects
                this.spawnObjects(dt);

                // Update objects
                this.updateObjects(dt);

                // Update HUD
                this.updateHUD();
            }

            spawnObjects(dt) {
                const settings = this.getDifficultySettings();
                const scaling = 1 + Math.min(0.6, (this.app.state.get('game.streak') * 0.05) + (this.app.state.get('game.score') / 400));
                const jarChance = settings.jarSpawn * scaling * (dt * 60);
                const beeChance = settings.beeSpawn * scaling * (dt * 60);

                // Spawn jars
                if (Math.random() < jarChance) {
                    const rnd = Math.random();
                    let type = 'normal';
                    if (rnd < 0.1) type = 'gold';
                    else if (rnd < 0.25) type = 'shield';

                    this.gameObjects.jars.push({
                        x: Math.random() * (this.virtualWidth - 40) + 20,
                        y: -20,
                        vy: settings.jarSpeed + Math.random() * 50,
                        type
                    });
                }

                // Spawn bees
                if (Math.random() < beeChance) {
                    this.gameObjects.bees.push({
                        x: Math.random() < 0.5 ? -20 : this.virtualWidth + 20,
                        y: Math.random() * this.virtualHeight * 0.6 + 50,
                        vx: (Math.random() < 0.5 ? -1 : 1) * (settings.beeSpeed + Math.random() * 50),
                        vy: 0
                    });
                }
            }

            updateObjects(dt) {
                const state = this.app.state.get('game');

                // Jars
                for (let i = this.gameObjects.jars.length - 1; i >= 0; i--) {
                    const jar = this.gameObjects.jars[i];
                    jar.y += jar.vy * dt;

                    const bearRect = {
                        x: this.gameObjects.bear.x - this.gameObjects.bear.width / 2,
                        y: this.gameObjects.bear.y - this.gameObjects.bear.height,
                        width: this.gameObjects.bear.width,
                        height: this.gameObjects.bear.height
                    };
                    const jarRect = { x: jar.x - 10, y: jar.y - 20, width: 20, height: 40 };

                    if (this.isColliding(bearRect, jarRect)) {
                        // Jar caught
                        this.gameObjects.jars.splice(i, 1);

                        let points = 10;
                        if (jar.type === 'gold') points = 30;
                        if (jar.type === 'shield') points = 15;

                        const multiplier = 1 + Math.min(2, state.streak * 0.1);
                        state.score += Math.round(points * multiplier);
                        state.streak++;

                        if (jar.type === 'shield') {
                            state.lives = Math.min(this.getLives(), state.lives + 1);
                        }

                        this.hitFlash = 0.8;

                        if (state.score > state.best) {
                            state.best = state.score;
                            this.app.state.set('game.best', state.best);
                        }

                        if (this.app.state.get('settings.sfx')) {
                            this.app.components.audio.play('honey');
                        }

                        if (this.app.state.get('settings.particles')) {
                            this.createParticles(jar.x, jar.y, jar.type);
                        }
                    }

                    if (jar.y > this.virtualHeight + 50) {
                        this.gameObjects.jars.splice(i, 1);
                        state.streak = 0;
                        this.missFlash = 0.6;
                    }
                }

                // Bees
                for (let i = this.gameObjects.bees.length - 1; i >= 0; i--) {
                    const bee = this.gameObjects.bees[i];
                    bee.x += bee.vx * dt;

                    const bearRect = {
                        x: this.gameObjects.bear.x - this.gameObjects.bear.width / 2,
                        y: this.gameObjects.bear.y - this.gameObjects.bear.height,
                        width: this.gameObjects.bear.width,
                        height: this.gameObjects.bear.height
                    };
                    const beeRect = { x: bee.x - 12, y: bee.y - 8, width: 24, height: 16 };

                    if (this.isColliding(bearRect, beeRect)) {
                        this.gameObjects.bees.splice(i, 1);
                        state.lives--;
                        state.streak = 0;
                        this.missFlash = 1;

                        if (this.app.state.get('settings.sfx')) {
                            this.app.components.audio.play('bee');
                        }

                        if (state.lives <= 0) {
                            this.gameOver();
                            return;
                        }
                    }

                    if (bee.x < -50 || bee.x > this.virtualWidth + 50) {
                        this.gameObjects.bees.splice(i, 1);
                    }
                }

                // Particles
                for (let i = this.gameObjects.particles.length - 1; i >= 0; i--) {
                    const p = this.gameObjects.particles[i];
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    p.life -= dt;

                    if (p.life <= 0) {
                        this.gameObjects.particles.splice(i, 1);
                    }
                }
                while (this.gameObjects.particles.length > 50) {
                    this.gameObjects.particles.shift();
                }
            }

            isColliding(a, b) {
                return (
                    a.x < b.x + b.width &&
                    a.x + a.width > b.x &&
                    a.y < b.y + b.height &&
                    a.y + a.height > b.y
                );
            }

            showOrientationTip() {
                const tip = document.getElementById('orientationTip');
                if (!tip) return;
                const shouldShow = window.innerWidth < 720 && window.innerWidth < window.innerHeight;
                tip.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) {
                    setTimeout(() => tip.style.display = 'none', 2500);
                }
            }

            createParticles(x, y, type) {
                const color = type === 'gold'
                    ? '#f59e0b'
                    : type === 'shield'
                        ? '#38bdf8'
                        : '#fbbf24';

                for (let i = 0; i < 5; i++) {
                    this.gameObjects.particles.push({
                        x,
                        y,
                        vx: (Math.random() - 0.5) * 200,
                        vy: -100 - Math.random() * 100,
                        color,
                        life: 1
                    });
                }
            }

            gameOver() {
                const state = this.app.state.get('game');
                this.stop();
                setTimeout(() => {
                    alert(`Game Over! Score: ${state.score}\nBest: ${state.best}`);
                }, 100);
            }

            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.drawImage(this.backgroundCanvas, 0, 0);
                this.drawBear();

                this.gameObjects.jars.forEach(jar => this.drawJar(jar));
                this.gameObjects.bees.forEach(bee => this.drawBee(bee));

                if (this.app.state.get('settings.particles')) {
                    this.gameObjects.particles.forEach(p => this.drawParticle(p));
                }

                if (this.hitFlash > 0 || this.missFlash > 0) {
                    this.ctx.fillStyle = this.hitFlash > 0 ? 'rgba(248, 191, 89, 0.25)' : 'rgba(220, 77, 63, 0.2)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    this.hitFlash = Math.max(0, this.hitFlash - 0.05);
                    this.missFlash = Math.max(0, this.missFlash - 0.05);
                }
            }

            drawBackground(cacheOnly = false) {
                const ctx = cacheOnly ? this.backgroundCtx : this.ctx;
                if (!ctx) return;
                const w = cacheOnly ? this.backgroundCanvas.width : this.canvas.width;
                const h = cacheOnly ? this.backgroundCanvas.height : this.canvas.height;

                ctx.clearRect(0, 0, w, h);
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, w, h * 0.7);
                ctx.fillStyle = '#98FB98';
                ctx.fillRect(0, h * 0.7, w, h * 0.3);
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(w * 0.2, h * 0.5, 30, 100);
                ctx.fillRect(w * 0.8, h * 0.5, 30, 100);
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.arc(w * 0.215, h * 0.5, 60, 0, Math.PI * 2);
                ctx.arc(w * 0.815, h * 0.5, 60, 0, Math.PI * 2);
                ctx.fill();

                if (!cacheOnly) {
                    this.ctx.drawImage(this.backgroundCanvas, 0, 0);
                }
            }

            drawBear() {
                const bear = this.gameObjects.bear;
                const scale = this.scale;

                this.ctx.save();
                this.ctx.translate(bear.x * scale, bear.y * scale);

                // Body
                this.ctx.fillStyle = '#fbbf24';
                this.ctx.beginPath();
                this.ctx.ellipse(0, -10 * scale, 25 * scale, 35 * scale, 0, 0, Math.PI * 2);
                this.ctx.fill();

                // Head
                this.ctx.beginPath();
                this.ctx.arc(0, -48 * scale, 20 * scale, 0, Math.PI * 2);
                this.ctx.fill();

                // Ears
                this.ctx.fillStyle = '#f59e0b';
                this.ctx.beginPath();
                this.ctx.arc(-12 * scale, -60 * scale, 8 * scale, 0, Math.PI * 2);
                this.ctx.arc(12 * scale, -60 * scale, 8 * scale, 0, Math.PI * 2);
                this.ctx.fill();

                // Eyes
                this.ctx.fillStyle = '#1f2937';
                this.ctx.beginPath();
                this.ctx.arc(-8 * scale, -52 * scale, 3 * scale, 0, Math.PI * 2);
                this.ctx.arc(8 * scale, -52 * scale, 3 * scale, 0, Math.PI * 2);
                this.ctx.fill();

                // Mouth
                this.ctx.strokeStyle = '#1f2937';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.arc(0, -45 * scale, 6 * scale, 0.2, Math.PI - 0.2);
                this.ctx.stroke();

                // Honey jar
                this.ctx.fillStyle = '#b45309';
                this.ctx.fillRect(-20 * scale, 0, 40 * scale, 30 * scale);
                this.ctx.fillStyle = '#f59e0b';
                this.ctx.fillRect(-18 * scale, 2 * scale, 36 * scale, 26 * scale);

                this.ctx.restore();
            }

            drawJar(jar) {
                const scale = this.scale;
                this.ctx.save();
                this.ctx.translate(jar.x * scale, jar.y * scale);

                let color = '#fbbf24';
                if (jar.type === 'gold') color = '#f59e0b';
                if (jar.type === 'shield') color = '#38bdf8';

                this.ctx.fillStyle = color;
                this.ctx.fillRect(-10 * scale, -20 * scale, 20 * scale, 40 * scale);

                this.ctx.fillStyle = '#92400e';
                this.ctx.fillRect(-12 * scale, -25 * scale, 24 * scale, 5 * scale);

                this.ctx.fillStyle = '#d97706';
                this.ctx.fillRect(-8 * scale, 0, 16 * scale, 15 * scale);

                this.ctx.restore();
            }

            drawBee(bee) {
                const scale = this.scale;
                this.ctx.save();
                this.ctx.translate(bee.x * scale, bee.y * scale);

                this.ctx.fillStyle = '#fbbf24';
                this.ctx.beginPath();
                this.ctx.ellipse(0, 0, 12 * scale, 8 * scale, 0, 0, Math.PI * 2);
                this.ctx.fill();

                this.ctx.fillStyle = '#1f2937';
                this.ctx.fillRect(-10 * scale, -2 * scale, 20 * scale, 4 * scale);

                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                this.ctx.beginPath();
                this.ctx.ellipse(-6 * scale, -10 * scale, 8 * scale, 5 * scale, Math.PI / 4, 0, Math.PI * 2);
                this.ctx.ellipse(6 * scale, -10 * scale, 8 * scale, 5 * scale, -Math.PI / 4, 0, Math.PI * 2);
                this.ctx.fill();

                this.ctx.restore();
            }

            drawParticle(p) {
                const scale = this.scale;
                this.ctx.save();
                this.ctx.translate(p.x * scale, p.y * scale);
                this.ctx.fillStyle = p.color;
                this.ctx.globalAlpha = p.life;
                const size = 4 * scale;
                this.ctx.fillRect(-size / 2, -size / 2, size, size);
                this.ctx.restore();
            }

            updateHUD() {
                const state = this.app.state.get('game');

                document.getElementById('scoreValue').textContent = state.score;
                document.getElementById('bestValue').textContent = state.best;
                document.getElementById('timeValue').textContent = Math.max(0, Math.floor(state.timeLeft));
                document.getElementById('livesValue').textContent = state.lives;
                document.getElementById('streakValue').textContent = state.streak;
            }

            handleKeyDown(e) {
                if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                    e.preventDefault();
                    this.keys.left = true;
                } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                    e.preventDefault();
                    this.keys.right = true;
                } else if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault();
                    this.pause();
                }
            }

            handleKeyUp(e) {
                if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                    e.preventDefault();
                    this.keys.left = false;
                } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                    e.preventDefault();
                    this.keys.right = false;
                }
            }
        }

        // SETTINGS MANAGER
        class SettingsManager {
            constructor(app) {
                this.app = app;
                this.panel = document.getElementById('settingsPanel');
                this.toggleBtn = document.getElementById('settingsToggle');
                this.closeBtn = document.getElementById('closeSettings');
                this.saveBtn = document.getElementById('saveSettings');
                this.resetBtn = document.getElementById('resetSettings');

                this.init();
            }

            init() {
                this.toggleBtn.addEventListener('click', () => this.app.openSettings());
                this.closeBtn.addEventListener('click', () => this.app.closeSettings());
                this.saveBtn.addEventListener('click', () => this.save());
                this.resetBtn.addEventListener('click', () => this.reset());

                this.loadToForm();
            }

            show() {
                this.panel.classList.add('active');
                this.loadToForm();
                this.previousFocus = document.activeElement;
                setTimeout(() => document.getElementById('difficultySelect')?.focus(), 50);
            }

            hide() {
                this.panel.classList.remove('active');
                if (this.previousFocus) {
                    this.previousFocus.focus({ preventScroll: true });
                } else {
                    this.toggleBtn.focus({ preventScroll: true });
                }
            }

            loadToForm() {
                const settings = this.app.state.get('settings');

                document.getElementById('difficultySelect').value = settings.difficulty;
                document.getElementById('musicToggle').checked = settings.music;
                document.getElementById('sfxToggle').checked = settings.sfx;
                document.getElementById('volumeSlider').value = settings.volume;
                document.getElementById('particlesToggle').checked = settings.particles;
                document.getElementById('animationsToggle').checked = settings.animations;

                if (this.app.components.audio) {
                    this.app.components.audio.updateVolume(settings.volume / 100);
                }
            }

            save() {
                const settings = {
                    difficulty: document.getElementById('difficultySelect').value,
                    music: document.getElementById('musicToggle').checked,
                    sfx: document.getElementById('sfxToggle').checked,
                    volume: parseInt(document.getElementById('volumeSlider').value, 10),
                    particles: document.getElementById('particlesToggle').checked,
                    animations: document.getElementById('animationsToggle').checked,
                    sensitivity: 260
                };

                this.app.state.set('settings', settings);
                this.app.closeSettings();
                this.showNotification('Settings saved!');
            }

            reset() {
                if (confirm('Reset all settings to defaults?')) {
                    const defaults = {
                        difficulty: 'medium',
                        music: true,
                        sfx: true,
                        volume: 80,
                        particles: true,
                        animations: true,
                        sensitivity: 260
                    };

                    this.app.state.set('settings', defaults);
                    this.loadToForm();
                    this.showNotification('Settings reset to defaults');
                }
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #f4b944, #f59e0b);
                    color: #3b2604;
                    padding: 12px 24px;
                    border-radius: 999px;
                    font-weight: 600;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                    z-index: 1001;
                    animation: slideDown 0.3s ease, slideUp 0.3s ease 2s forwards;
                `;

                document.body.appendChild(notification);

                if (!document.getElementById('settingsNotificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'settingsNotificationStyles';
                    style.textContent = `
                        @keyframes slideDown {
                            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                            to { transform: translateX(-50%) translateY(0); opacity: 1; }
                        }
                        @keyframes slideUp {
                            from { transform: translateX(-50%) translateY(0); opacity: 1; }
                            to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }
        }

        // AUDIO MANAGER
        class AudioManager {
            constructor(app) {
                this.app = app;
                this.audioElements = {};
                this.audioContext = null;
                this.init();
            }

            init() {
                this.audioElements.bgMusic = document.getElementById('bgMusic');
                this.audioElements.honey   = document.getElementById('honeySound');
                this.audioElements.page    = document.getElementById('pageSound');
                this.audioElements.bee     = document.getElementById('beeSound');

                this.createFallbackAudio();

                this.updateVolume(this.app.state.get('settings.volume') / 100);

                const unlockAudio = () => {
                    this.audioElements.bgMusic.play().then(() => {
                        this.audioElements.bgMusic.pause();
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('keydown', unlockAudio);
                    }).catch(() => {});
                };

                document.addEventListener('click', unlockAudio, { once: true });
                document.addEventListener('keydown', unlockAudio, { once: true });
            }

            createFallbackAudio() {
                this.silentAudio = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';

                Object.values(this.audioElements).forEach(audio => {
                    if (!audio.src) {
                        audio.src = this.silentAudio;
                    }
                });
            }

            updateVolume(volume) {
                Object.values(this.audioElements).forEach(audio => {
                    audio.volume = volume;
                });
            }

            play(sound) {
                const audio = this.audioElements[sound];
                if (audio && this.app.state.get('settings.sfx')) {
                    audio.currentTime = 0;
                    audio.play().catch(() => this.playTone(sound));
                }
            }

            playTone(type) {
                if (!this.audioContext) {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = AudioCtx ? new AudioCtx() : null;
                }
                if (!this.audioContext) return;
                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gain = ctx.createGain();
                oscillator.type = type === 'bee' ? 'sawtooth' : 'sine';
                oscillator.frequency.value = type === 'bee' ? 320 : 220;
                gain.gain.value = 0.05 * (this.app.state.get('settings.volume') / 100);
                oscillator.connect(gain).connect(ctx.destination);
                oscillator.start();
                oscillator.stop(ctx.currentTime + 0.2);
            }

            toggleMusic() {
                const musicOn = this.app.state.get('settings.music');
                const newValue = !musicOn;
                this.app.state.set('settings.music', newValue);

                if (newValue) {
                    this.audioElements.bgMusic.play().catch(() => {});
                } else {
                    this.audioElements.bgMusic.pause();
                }
            }
        }

        // WISHES MANAGER
        class WishesManager {
            constructor(app) {
                this.app = app;
                this.form = document.getElementById('wishesForm');
                this.display = document.getElementById('wishesDisplay');
                this.charCount = document.getElementById('charCount');
                this.init();
            }

            init() {
                this.form.addEventListener('submit', (e) => withErrorBoundary(() => this.submitWish(e)));
                this.wishMessage.addEventListener('input', () => this.updateCharCount());
                this.updateCharCount();
                this.loadWishes();
            }

            get wishMessage() {
                return document.getElementById('wishMessage');
            }

            updateCharCount() {
                const length = this.wishMessage.value.length;
                this.charCount.textContent = length;
                this.wishMessage.style.borderColor = length > 500 ? 'var(--color-red)' : 'var(--color-parchment-dark)';
            }

            submitWish(e) {
                e.preventDefault();

                const name = document.getElementById('guestName').value.trim();
                const relation = document.getElementById('guestRelation').value;
                const message = this.wishMessage.value.trim();

                if (!name || !message || message.length > 500) {
                    alert('Please fill in all fields and keep message under 500 characters.');
                    return;
                }

                const wish = {
                    id: Date.now(),
                    name: this.escapeText(name),
                    relation,
                    message: this.escapeText(message),
                    date: new Date().toISOString()
                };

                const wishes = [...this.app.state.get('wishes'), wish];
                this.app.state.set('wishes', wishes);

                this.renderWishes();

                this.form.reset();
                this.updateCharCount();

                this.showConfirmation();
            }

            loadWishes() {
                const wishes = this.app.state.get('wishes');
                if (wishes.length === 0) {
                    this.addSampleWishes();
                }
                this.renderWishes();
            }

            addSampleWishes() {
                const now = new Date().toISOString();
                const samples = [
                    {
                        id: 1,
                        name: "Owl",
                        relation: "woodland-friend",
                        message: "May your days be filled with wonder and your nights with sweet dreams.",
                        date: now
                    },
                    {
                        id: 2,
                        name: "Piglet",
                        relation: "woodland-friend",
                        message: "Remember: even the smallest creatures can have the biggest hearts.",
                        date: now
                    }
                ];
                this.app.state.set('wishes', samples);
            }

            getRelationText(relation) {
                const relations = {
                    'family': 'Family',
                    'friend': 'Friend',
                    'colleague': 'Colleague',
                    'woodland-friend': 'Woodland Friend'
                };
                return relations[relation] || 'Guest';
            }

            escapeText(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.textContent;
            }

            renderWishes() {
                this.display.querySelectorAll('.wish-item').forEach(el => el.remove());
                const wishes = this.app.state.get('wishes');
                wishes.forEach(wish => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'wish-item';
                    const card = document.createElement('div');
                    card.style.cssText = 'background: white; padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-sm); border-left: 4px solid var(--color-gold);';

                    const header = document.createElement('div');
                    header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs); flex-wrap: wrap;';
                    const nameEl = document.createElement('strong');
                    nameEl.style.color = 'var(--color-green)';
                    nameEl.textContent = wish.name;
                    const dateEl = document.createElement('small');
                    dateEl.style.color = 'var(--color-ink-muted)';
                    dateEl.textContent = new Date(wish.date).toLocaleDateString();
                    header.append(nameEl, dateEl);

                    const messageEl = document.createElement('p');
                    messageEl.style.marginBottom = 'var(--space-xs)';
                    messageEl.textContent = wish.message;

                    const footer = document.createElement('div');
                    footer.style.cssText = 'display:flex; justify-content: space-between; align-items:center; gap: var(--space-sm); flex-wrap: wrap;';
                    const relationEl = document.createElement('small');
                    relationEl.style.color = 'var(--color-blue)';
                    relationEl.textContent = this.getRelationText(wish.relation);
                    footer.append(relationEl);
                    card.append(header, messageEl, footer);
                    wrapper.appendChild(card);
                    this.display.appendChild(wrapper);
                });
            }

            showConfirmation() {
                const confirmation = document.createElement('div');
                confirmation.textContent = 'Thank you for sharing your wishes!';
                confirmation.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: var(--space-lg);
                    border-radius: var(--radius-md);
                    box-shadow: var(--shadow-heavy);
                    z-index: 1001;
                    text-align: center;
                    border: 3px solid var(--color-gold);
                `;

                document.body.appendChild(confirmation);

                setTimeout(() => {
                    confirmation.style.opacity = '0';
                    confirmation.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => confirmation.remove(), 300);
                }, 2000);
            }
        }

        // FOOTER ACTIONS
        class FooterActions {
            static init(app) {
                document.getElementById('printBtn').addEventListener('click', () => this.printPage());
                document.getElementById('shareBtn').addEventListener('click', () => this.sharePage());
                document.getElementById('toggleMusicBtn').addEventListener('click', () => app.components.audio.toggleMusic());
            }

            static printPage() {
                window.print();
            }

            static async sharePage() {
                const shareData = {
                    title: "Baby Gunnar's Hundred Acre Wood Shower",
                    text: 'Join the celebration in the Hundred Acre Wood!',
                    url: window.location.href
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else if (navigator.clipboard) {
                        await navigator.clipboard.writeText(shareData.url);
                        alert('Link copied to clipboard!');
                    } else {
                        alert(shareData.url);
                    }
                } catch (err) {
                    console.log('Error sharing:', err);
                }
            }
        }

        // INITIALIZE APPLICATION
        const app = new BabyShowerApp();

        SafeEvents.add(window, 'beforeunload', () => SafeEvents.removeAll());

        document.addEventListener('DOMContentLoaded', () => {
            withErrorBoundary(() => {
                app.init();
                FooterActions.init(app);
            });
        });

        // Expose for debugging
        window.BabyShowerApp = app;
    </script>
</body>
</html>