
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Pooh's Honey Barrel - Storybook Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="A Winnie-the-Pooh style storybook game where Pooh carries a barrel and catches honeybee drops while avoiding buzzing bees." />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Playfair+Display:wght@400;600;700&family=Schoolbell&display=swap" rel="stylesheet" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root {
            --pooh-yellow: #f7c948;
            --pooh-yellow-light: #ffe7a3;
            --pooh-yellow-dark: #e0a81b;
            --pooh-red: #d64545;
            --page-cream: #fdf5e6;
            --page-edge: #f2e1c4;
            --ink-brown: #3e2723;
            --ink-soft: #5d4037;
            --bg-honey: #fff4ce;
            --shadow-md: 0 10px 24px rgba(102, 72, 39, 0.18);
            --shadow-sm: 0 4px 10px rgba(102, 72, 39, 0.14);
            --radius-md: 18px;
            --radius-lg: 26px;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Nunito", system-ui, sans-serif;
            background:
                radial-gradient(circle at top left, #ffe9c4 0, transparent 50%),
                radial-gradient(circle at bottom right, #ffd9b0 0, transparent 50%),
                #f7e0c2;
            color: var(--ink-brown);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* Storybook page frame */

        .page-frame {
            width: 100%;
            max-width: 520px;
            margin: 12px auto 16px;
            padding: 10px;
            background: linear-gradient(135deg, #f4e0c3, #e8cfad);
            border-radius: 18px;
            box-shadow:
                0 18px 40px rgba(96, 63, 32, 0.25),
                0 0 0 2px rgba(255, 255, 255, 0.5);
        }

        .page {
            border-radius: 14px;
            background:
                repeating-linear-gradient(
                    to bottom,
                    rgba(255, 255, 255, 0.9),
                    rgba(255, 255, 255, 0.9) 32px,
                    rgba(255, 250, 235, 0.9) 33px
                ),
                var(--page-cream);
            border: 1px solid rgba(153, 110, 56, 0.35);
            padding: 18px 16px 22px;
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.7),
                var(--shadow-md);
        }

        .skip-link {
            position: absolute;
            left: -999px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .skip-link:focus {
            position: fixed;
            left: 16px;
            top: 16px;
            width: auto;
            height: auto;
            padding: 8px 12px;
            background: #000;
            color: #fff;
            z-index: 50;
            border-radius: 999px;
        }

        /* Header / Story title */

        header {
            text-align: center;
            margin-bottom: 14px;
        }

        .logo-icon {
            width: 76px;
            height: 76px;
            border-radius: 22px;
            background:
                radial-gradient(circle at 30% 30%, #fff8d9 0, #f7c948 45%, #e0a81b 100%);
            box-shadow: 0 10px 24px rgba(204, 149, 67, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 2.7rem;
        }

        h1 {
            font-family: "Playfair Display", Georgia, "Times New Roman", serif;
            font-weight: 700;
            font-size: 2.0rem;
            margin: 0 0 2px;
            letter-spacing: 0.04em;
        }

        .subtitle {
            font-family: "Schoolbell", system-ui, sans-serif;
            font-size: 1rem;
            color: var(--ink-soft);
        }

        .divider {
            width: 90px;
            height: 4px;
            border-radius: 999px;
            margin: 10px auto 4px;
            background: linear-gradient(90deg, #f7c948, #f29d4b, #f7c948);
        }

        .chapter-label {
            font-size: 0.82rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: rgba(62, 39, 35, 0.7);
            margin-bottom: 8px;
        }

        /* Storybox / Event details */

        .story-box {
            background: rgba(255, 250, 235, 0.92);
            border-radius: var(--radius-lg);
            padding: 12px 12px 14px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(153, 110, 56, 0.25);
        }

        .story-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--ink-soft);
            margin-bottom: 8px;
        }

        .story-text:first-letter {
            font-family: "Playfair Display", serif;
            font-size: 1.6rem;
            float: left;
            line-height: 1;
            padding-right: 4px;
            padding-top: 1px;
            color: var(--pooh-red);
        }

        .event-list {
            border-top: 1px dashed rgba(153, 110, 56, 0.4);
            margin-top: 8px;
            padding-top: 8px;
            font-size: 0.9rem;
        }

        .event-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .event-label {
            font-weight: 600;
        }

        /* Game shell */

        .game-shell {
            background: rgba(255, 252, 240, 0.95);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 14px 12px 18px;
            border: 1px solid rgba(153, 110, 56, 0.32);
            position: relative;
        }

        .game-shell::before {
            content: "";
            position: absolute;
            inset: 6px 10px auto 10px;
            height: 4px;
            border-radius: 999px;
            background: linear-gradient(90deg, #f7c948, #f29d4b, #f7c948);
            opacity: 0.6;
        }

        .game-shell header {
            text-align: left;
            margin-bottom: 10px;
        }

        .game-shell h2 {
            font-family: "Schoolbell", system-ui, sans-serif;
            font-size: 1.5rem;
            margin: 4px 0 4px;
        }

        .game-shell p {
            margin: 0;
            font-size: 0.94rem;
            color: var(--ink-soft);
        }

        .stats-row {
            display: flex;
            gap: 6px;
            margin: 12px 0 10px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .stat-pill {
            min-width: 82px;
            background: linear-gradient(135deg, var(--bg-honey), var(--pooh-yellow-light));
            border-radius: 999px;
            padding: 5px 10px;
            box-shadow: var(--shadow-sm);
            font-size: 0.8rem;
            border: 1px solid rgba(153, 110, 56, 0.3);
        }

        .stat-pill--highlight {
            background: linear-gradient(135deg, #ffe8a3, #f8c245);
        }

        .stat-label {
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.04em;
            color: rgba(62, 39, 35, 0.75);
            font-size: 0.72rem;
        }

        .stat-value {
            font-weight: 800;
            font-size: 1.08rem;
        }

        .difficulty-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            margin-top: 4px;
        }

        .difficulty-row label {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--ink-soft);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .difficulty-row label i {
            color: var(--pooh-yellow-dark);
        }

        .difficulty-row select {
            flex: 1;
            padding: 8px 10px;
            font-size: 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(153, 110, 56, 0.35);
            background: #fffdf6;
        }

        /* Canvas area */

        .canvas-shell {
            margin-bottom: 12px;
            border-radius: var(--radius-md);
            padding: 6px;
            background: linear-gradient(135deg, #ffe7b2, #ffd18a);
            box-shadow: var(--shadow-md);
        }

        .canvas-inner {
            border-radius: var(--radius-md);
            overflow: hidden;
            background: #cbe3ff;
            position: relative;
        }

        .game-canvas {
            display: block;
            width: 100%;
            touch-action: none;
        }

        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 12px;
            background: rgba(255, 249, 226, 0.94);
        }

        .overlay-title {
            font-family: "Schoolbell", system-ui, sans-serif;
            font-size: 1.55rem;
            margin-bottom: 6px;
        }

        .overlay-text {
            font-size: 0.95rem;
            color: var(--ink-soft);
        }

        /* Controls + status */

        .controls-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .btn {
            flex: 1;
            border: none;
            border-radius: 999px;
            padding: 9px 11px;
            font-size: 0.95rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--pooh-yellow), var(--pooh-yellow-dark));
            color: #3e2723;
        }

        .btn-secondary {
            background: #fffdf6;
            color: var(--ink-soft);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .status {
            font-size: 0.84rem;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255, 249, 230, 0.9);
            color: var(--ink-soft);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status i {
            color: var(--pooh-yellow-dark);
        }

        footer {
            text-align: center;
            font-size: 0.78rem;
            color: rgba(62, 39, 35, 0.7);
            margin-top: 12px;
            font-style: italic;
        }

        footer i {
            color: var(--pooh-red);
        }

        @media (max-width: 480px) {
            .page-frame {
                margin: 8px 6px 12px;
                padding: 8px;
            }

            .page {
                padding: 14px 12px 18px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .game-shell h2 {
                font-size: 1.35rem;
            }
        }
    </style>
</head>
<body>
<a href="#main" class="skip-link">Skip to main content</a>

<div class="page-frame">
    <div class="page">
        <header>
            <div class="logo-icon" aria-hidden="true">üçØ</div>
            <div class="chapter-label">A Hundred Acre Mini-Adventure</div>
            <h1>Pooh's Honey Barrel</h1>
            <div class="divider"></div>
            <p class="subtitle">Pooh carries his barrel, honeybee drops fall from the sky, and the bees are very, very busy.</p>
        </header>

        <!-- Story intro / invitation -->
        <section class="story-box" aria-label="Story introduction">
            <p class="story-text">
                Once upon an afternoon in the Hundred Acre Wood, Pooh Bear found his honey cupboard terribly empty. So he picked up his very best barrel, stepped out into the sunshine, and waited for the honeybees to share a few drippy drops from the sky. Of course, the bees themselves were not to be bumped into, because bees have very particular feelings about bears and barrels.
            </p>
            <div class="event-list">
                <div class="event-row">
                    <span class="event-label">When:</span>
                    <span>April 24 ¬∑ 2:00‚Äì5:00 PM</span>
                </div>
                <div class="event-row">
                    <span class="event-label">Where:</span>
                    <span>The Hundred Acre Wood</span>
                </div>
                <div class="event-row">
                    <span class="event-label">Your Part:</span>
                    <span>Help Pooh catch the honeybee drops!</span>
                </div>
            </div>
        </section>

        <main id="main">
            <section class="game-shell" aria-label="Honey Barrel game">
                <header>
                    <h2>The Honey Barrel Game</h2>
                    <p>Slide Pooh along the ground with your finger (or mouse). Catch the glowing honeybee drops in his barrel, avoid the buzzing bees, and see how high your storybook score can go.</p>
                </header>

                <!-- Stats -->
                <div class="stats-row">
                    <div class="stat-pill stat-pill--highlight">
                        <div class="stat-label">Score</div>
                        <div class="stat-value" id="score">0</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Time</div>
                        <div class="stat-value" id="time">60</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Drops</div>
                        <div class="stat-value" id="caught">0</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Best</div>
                        <div class="stat-value" id="best">0</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-label">Streak</div>
                        <div class="stat-value" id="streak">x1</div>
                    </div>
                </div>

                <!-- Difficulty -->
                <div class="difficulty-row">
                    <label for="difficulty">
                        <i class="fas fa-sliders-h"></i>
                        Honey Weather
                    </label>
                    <select id="difficulty">
                        <option value="easy">Gentle Drips</option>
                        <option value="medium" selected>Busy Bees</option>
                        <option value="hard">Honey Storm</option>
                    </select>
                </div>

                <!-- Canvas -->
                <div class="canvas-shell">
                    <div class="canvas-inner">
                        <canvas id="gameCanvas" class="game-canvas"></canvas>
                        <div class="overlay" id="overlay">
                            <div class="overlay-title">Ready, Pooh?</div>
                            <div class="overlay-text">
                                Tap <strong>Start</strong>, then slide your finger to move Pooh and his barrel.
                                Catch the glowing <strong>honeybee drops</strong>, but mind the <strong>bees</strong> ‚Äî they don't like barrels bumping into them.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls-row" aria-label="Game controls">
                    <button class="btn btn-primary" id="startBtn">
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button class="btn btn-secondary" id="pauseBtn" disabled>
                        <i class="fas fa-pause"></i> Pause
                    </button>
                </div>

                <!-- Status -->
                <div class="status" id="status">
                    <i class="fas fa-feather-pointed"></i>
                    <span>Tap Start, then gently drag to move Pooh left and right.</span>
                </div>
            </section>
        </main>

        <footer>
            Told with warmth in the Hundred Acre Wood &mdash; a little fan-made storybook game.
        </footer>
    </div>
</div>

<script>
(function () {
    function clampNumber(n) {
        return isNaN(n) ? 0 : n;
    }

    function randRange(min, max) {
        return min + Math.random() * (max - min);
    }

    class PoohHoneyBarrelGame {
        constructor() {
            this.canvas  = document.getElementById('gameCanvas');
            this.ctx     = this.canvas.getContext('2d');

            this.scoreEl  = document.getElementById('score');
            this.timeEl   = document.getElementById('time');
            this.caughtEl = document.getElementById('caught');
            this.bestEl   = document.getElementById('best');
            this.streakEl = document.getElementById('streak');
            this.statusEl = document.getElementById('status').querySelector('span');
            this.overlay  = document.getElementById('overlay');
            this.startBtn = document.getElementById('startBtn');
            this.pauseBtn = document.getElementById('pauseBtn');
            this.diffSelect = document.getElementById('difficulty');

            this.width  = 0;
            this.height = 0;

            this.running  = false;
            this.paused   = false;
            this.timeLeft = 60;
            this.score    = 0;
            this.caught   = 0;

            this.combo      = 0;
            this.multiplier = 1;

            this.entities = []; // mix of drops + bees
            this.popups   = []; // floating texts

            this.timerId       = null;
            this.lastFrameTime = 0;

            this.cloudOffset = 0;
            this.beeHitTimer = 0;

            this.player = {
                x: 0,
                y: 0,
                width: 82,
                height: 50
            };

            this.resizeHandler     = this.handleResize.bind(this);
            this.touchHandler      = this.handleTouch.bind(this);
            this.mouseMoveHandler  = this.handleMouseMove.bind(this);

            this.init();
        }

        init() {
            this.loadBestScore();
            this.handleResize();

            window.addEventListener('resize', this.resizeHandler);

            this.canvas.addEventListener('touchstart', this.touchHandler, { passive: false });
            this.canvas.addEventListener('touchmove',  this.touchHandler, { passive: false });
            this.canvas.addEventListener('mousemove',  this.mouseMoveHandler);

            this.startBtn.addEventListener('click', () => {
                if (!this.running) {
                    this.start();
                } else if (this.paused) {
                    this.resume();
                } else {
                    this.restart();
                }
            });

            this.pauseBtn.addEventListener('click', () => {
                if (!this.running) return;
                if (this.paused) {
                    this.resume();
                } else {
                    this.pause();
                }
            });

            this.diffSelect.addEventListener('change', () => {
                this.statusEl.textContent = 'The weather will feel different next time you start.';
            });

            this.drawIdleScreen();
        }

        loadBestScore() {
            let stored = null;
            try {
                stored = localStorage.getItem('pooh_honey_barrel_best');
            } catch (e) {
                stored = null;
            }
            let best = stored ? parseInt(stored, 10) : 0;
            best = clampNumber(best);
            this.bestEl.textContent = best;
        }

        saveBestScore() {
            let currentBest = clampNumber(parseInt(this.bestEl.textContent, 10));
            if (this.score > currentBest) {
                this.bestEl.textContent = this.score;
                try {
                    localStorage.setItem('pooh_honey_barrel_best', String(this.score));
                } catch (e) {
                    // ignore
                }
            }
        }

        handleResize() {
            const container = this.canvas.parentElement;
            if (!container) return;
            const width  = container.clientWidth;
            const height = Math.min(width * 1.3, 500);

            this.width  = width;
            this.height = height;
            this.canvas.width  = width;
            this.canvas.height = height;

            this.player.y = this.height - 52;
            if (!this.player.x) {
                this.player.x = this.width / 2;
            }

            if (!this.running) {
                this.drawIdleScreen();
            }
        }

        getDifficultyConfig() {
            const diff = this.diffSelect.value;
            if (diff === 'easy') {
                return {
                    drops: 4,
                    bees: 2,
                    minSpeed: 80,
                    maxSpeed: 130,
                    dropScore: 40,
                    duration: 60
                };
            } else if (diff === 'hard') {
                return {
                    drops: 6,
                    bees: 4,
                    minSpeed: 150,
                    maxSpeed: 230,
                    dropScore: 70,
                    duration: 45
                };
            }
            // medium
            return {
                drops: 5,
                bees: 3,
                minSpeed: 110,
                maxSpeed: 190,
                dropScore: 55,
                duration: 50
            };
        }

        start() {
            const config = this.getDifficultyConfig();
            this.running = true;
            this.paused  = false;

            this.score      = 0;
            this.caught     = 0;
            this.combo      = 0;
            this.multiplier = 1;

            this.timeLeft    = config.duration;
            this.dropScore   = config.dropScore;
            this.minSpeed    = config.minSpeed;
            this.maxSpeed    = config.maxSpeed;

            this.scoreEl.textContent  = '0';
            this.caughtEl.textContent = '0';
            this.timeEl.textContent   = String(this.timeLeft);
            this.streakEl.textContent = 'x1';
            this.statusEl.textContent = 'Catch honeybee drops in the barrel, and don\'t bump the bees.';

            this.overlay.style.display = 'none';

            this.startBtn.innerHTML = '<i class="fas fa-rotate-right"></i> Restart';
            this.pauseBtn.disabled  = false;
            this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';

            this.createEntities(config.drops, config.bees);
            this.popups = [];
            this.lastFrameTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
            this.beeHitTimer = 0;

            if (this.timerId) {
                clearInterval(this.timerId);
            }

            this.timerId = setInterval(() => {
                if (!this.running || this.paused) return;
                this.timeLeft -= 1;
                if (this.timeLeft <= 0) {
                    this.timeLeft = 0;
                    this.timeEl.textContent = '0';
                    this.gameOver();
                } else {
                    this.timeEl.textContent = String(this.timeLeft);
                }
            }, 1000);

            const self = this;
            requestAnimationFrame(function (t) { self.loop(t); });
        }

        restart() {
            this.running = false;
            this.paused  = false;
            if (this.timerId) {
                clearInterval(this.timerId);
                this.timerId = null;
            }
            this.start();
        }

        pause() {
            this.paused = true;
            this.pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            this.statusEl.textContent = 'Paused. Pooh is waiting patiently.';
        }

        resume() {
            if (!this.running) return;
            this.paused = false;
            this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            this.statusEl.textContent = 'Back to catching honey!';
            this.lastFrameTime = (typeof performance !== 'undefined' && performance.now)
                ? performance.now()
                : Date.now();
            const self = this;
            requestAnimationFrame(function (t) { self.loop(t); });
        }

        gameOver() {
            this.running = false;
            this.paused  = false;
            if (this.timerId) {
                clearInterval(this.timerId);
                this.timerId = null;
            }

            this.saveBestScore();

            this.pauseBtn.disabled = true;
            this.statusEl.textContent =
                'Time\'s up! Score: ' + this.score +
                ' ¬∑ Drops caught: ' + this.caught +
                ' ¬∑ Best streak: x' + this.multiplier + '.';

            this.overlay.style.display = 'flex';
            this.overlay.querySelector('.overlay-title').textContent = 'A very good catch!';
            this.overlay.querySelector('.overlay-text').textContent =
                'Tap Restart to try for an even lovelier honey day.';
        }

        createEntities(dropCount, beeCount) {
            this.entities = [];
            for (let i = 0; i < dropCount; i++) {
                this.entities.push(this.randomEntity('drop', true));
            }
            for (let j = 0; j < beeCount; j++) {
                this.entities.push(this.randomEntity('bee', true));
            }
        }

        randomEntity(type, fromTop) {
            let radius = (type === 'bee') ? 16 : 18;
            let x = radius + Math.random() * (this.width - radius * 2);
            let y = fromTop ? -Math.random() * this.height : -radius;
            let speed = this.minSpeed + Math.random() * (this.maxSpeed - this.minSpeed);
            let drift = randRange(-30, 30);

            let isGolden = false;
            if (type === 'drop' && Math.random() < 0.18) {
                isGolden = true;
                radius += 2;
            }

            return {
                x: x,
                y: y,
                radius: radius,
                speed: speed,
                drift: drift,
                type: type,
                isGolden: isGolden
            };
        }

        respawnEntity(entity, type) {
            const newEntity = this.randomEntity(type || entity.type, false);
            entity.x = newEntity.x;
            entity.y = newEntity.y;
            entity.radius = newEntity.radius;
            entity.speed = newEntity.speed;
            entity.drift = newEntity.drift;
            entity.type = newEntity.type;
            entity.isGolden = newEntity.isGolden;
        }

        handleTouch(event) {
            if (!this.running || this.paused) return;

            event.preventDefault();
            if (!event.touches || event.touches.length === 0) return;

            const rect = this.canvas.getBoundingClientRect();
            const clientX = event.touches[0].clientX;
            const x = clientX - rect.left;
            const halfW = this.player.width / 2;
            this.player.x = Math.max(halfW, Math.min(this.width - halfW, x));
        }

        handleMouseMove(event) {
            if (!this.running || this.paused) return;

            const rect = this.canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const halfW = this.player.width / 2;
            this.player.x = Math.max(halfW, Math.min(this.width - halfW, x));
        }

        loop(timestamp) {
            if (!this.running || this.paused) return;

            const now = (typeof timestamp === 'number')
                ? timestamp
                : ((typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now());

            let dt = (now - this.lastFrameTime) / 1000;
            this.lastFrameTime = now;
            if (dt < 0 || dt > 0.5) {
                dt = 0.016;
            }

            this.update(dt);
            this.draw();

            const self = this;
            requestAnimationFrame(function (t) { self.loop(t); });
        }

        update(dt) {
            this.cloudOffset += dt * 15;
            if (this.beeHitTimer > 0) {
                this.beeHitTimer -= dt;
                if (this.beeHitTimer < 0) this.beeHitTimer = 0;
            }

            for (let i = 0; i < this.entities.length; i++) {
                const e = this.entities[i];
                e.y += e.speed * dt;
                e.x += e.drift * dt * 0.4;

                if (e.x < e.radius) e.x = e.radius;
                if (e.x > this.width - e.radius) e.x = this.width - e.radius;

                if (this.checkCatch(e)) {
                    if (e.type === 'drop') {
                        this.onCatchDrop(e);
                    } else {
                        this.onBeeHit(e);
                    }
                    this.respawnEntity(e);
                    continue;
                }

                if (e.y - e.radius > this.height) {
                    if (e.type === 'drop') {
                        this.onMissDrop();
                    }
                    this.respawnEntity(e);
                }
            }

            for (let p = 0; p < this.popups.length; p++) {
                const popup = this.popups[p];
                popup.y += popup.vy * dt;
                popup.opacity -= dt * 1.3;
            }
            this.popups = this.popups.filter(p => p.opacity > 0);
        }

        onCatchDrop(entity) {
            this.combo += 1;
            this.multiplier = 1 + Math.floor(this.combo / 3);
            if (this.multiplier < 1) this.multiplier = 1;
            if (this.multiplier > 5) this.multiplier = 5;

            let base = this.dropScore;
            if (entity.isGolden) {
                base *= 2;
            }
            const gained = base * this.multiplier;

            this.score  += gained;
            this.caught += 1;

            if (this.score < 0) this.score = 0;

            this.scoreEl.textContent  = String(this.score);
            this.caughtEl.textContent = String(this.caught);
            this.streakEl.textContent = 'x' + this.multiplier;

            this.statusEl.textContent =
                (entity.isGolden ? 'A very special golden drop! ' : '') +
                '+' + gained + ' points (streak x' + this.multiplier + ').';

            this.popups.push({
                x: entity.x,
                y: entity.y,
                text: '+' + gained,
                opacity: 1,
                vy: -40,
                golden: entity.isGolden,
                bad: false
            });
        }

        onMissDrop() {
            this.combo = 0;
            this.multiplier = 1;
            this.streakEl.textContent = 'x1';
            this.statusEl.textContent = 'A drop slipped past the barrel. Streak reset.';
        }

        onBeeHit(entity) {
            this.combo = 0;
            this.multiplier = 1;
            this.streakEl.textContent = 'x1';

            const penaltyPoints = 40;
            const penaltyTime   = 3;

            this.score -= penaltyPoints;
            if (this.score < 0) this.score = 0;

            this.timeLeft -= penaltyTime;
            if (this.timeLeft < 0) this.timeLeft = 0;
            this.timeEl.textContent = String(this.timeLeft);

            this.statusEl.textContent =
                'Ouch! Bee bump. -' + penaltyPoints + ' points, -' + penaltyTime + ' seconds.';

            this.popups.push({
                x: entity.x,
                y: entity.y,
                text: '-' + penaltyPoints,
                opacity: 1,
                vy: -35,
                golden: false,
                bad: true
            });

            this.beeHitTimer = 0.3;
        }

        checkCatch(entity) {
            const halfW = this.player.width / 2;
            const halfH = this.player.height / 2;

            // Treat collision area as the barrel area in front of Pooh
            const catchWidth = this.player.width * 0.7;
            const catchHeight = this.player.height * 0.7;
            const centerX = this.player.x + this.player.width * 0.1; // shift a bit to barrel
            const centerY = this.player.y - this.player.height * 0.05;

            const left   = centerX - catchWidth / 2;
            const right  = centerX + catchWidth / 2;
            const top    = centerY - catchHeight / 2;
            const bottom = centerY + catchHeight / 2;

            const closestX = Math.max(left, Math.min(entity.x, right));
            const closestY = Math.max(top, Math.min(entity.y, bottom));

            const dx = entity.x - closestX;
            const dy = entity.y - closestY;
            const distSq = dx * dx + dy * dy;
            return distSq <= entity.radius * entity.radius;
        }

        drawBackground() {
            const ctx = this.ctx;
            ctx.clearRect(0, 0, this.width, this.height);

            // sky
            const grad = ctx.createLinearGradient(0, 0, 0, this.height);
            grad.addColorStop(0, '#cbe3ff');
            grad.addColorStop(0.55, '#e9f2ff');
            grad.addColorStop(1, '#ffe59c');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, this.width, this.height);

            // distant hills
            ctx.fillStyle = '#b5d28d';
            ctx.beginPath();
            ctx.moveTo(0, this.height - 80);
            ctx.quadraticCurveTo(this.width * 0.25, this.height - 130, this.width * 0.5, this.height - 90);
            ctx.quadraticCurveTo(this.width * 0.8, this.height - 70, this.width, this.height - 100);
            ctx.lineTo(this.width, this.height);
            ctx.lineTo(0, this.height);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = '#9fc46f';
            ctx.beginPath();
            ctx.moveTo(0, this.height - 55);
            ctx.quadraticCurveTo(this.width * 0.3, this.height - 90, this.width * 0.7, this.height - 60);
            ctx.quadraticCurveTo(this.width * 0.95, this.height - 50, this.width, this.height - 70);
            ctx.lineTo(this.width, this.height);
            ctx.lineTo(0, this.height);
            ctx.closePath();
            ctx.fill();

            // ground strip
            ctx.fillStyle = '#8bc34a';
            ctx.fillRect(0, this.height - 32, this.width, 32);

            // clouds
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            const offset = this.cloudOffset;
            const w = this.width;

            this.drawCloud(ctx, (offset * 0.4) % (w + 160) - 80, 40, 60);
            this.drawCloud(ctx, (offset * 0.3 + 200) % (w + 200) - 100, 70, 80);
            this.drawCloud(ctx, (offset * 0.25 + 420) % (w + 220) - 110, 50, 50);
        }

        drawCloud(ctx, x, y, size) {
            ctx.beginPath();
            ctx.arc(x, y, size * 0.45, 0, Math.PI * 2);
            ctx.arc(x + size * 0.4, y + size * 0.1, size * 0.4, 0, Math.PI * 2);
            ctx.arc(x - size * 0.4, y + size * 0.15, size * 0.4, 0, Math.PI * 2);
            ctx.fill();
        }

        drawPoohWithBarrel() {
            const ctx = this.ctx;
            const halfW = this.player.width / 2;
            const halfH = this.player.height / 2;
            const x = this.player.x;
            const y = this.player.y;

            // Ground shadow
            ctx.fillStyle = 'rgba(62,39,35,0.26)';
            ctx.beginPath();
            ctx.ellipse(x + 4, y + halfH, halfW * 0.9, halfH * 0.4, 0, 0, Math.PI * 2);
            ctx.fill();

            // Body (bear)
            ctx.fillStyle = '#f7c948';
            ctx.beginPath();
            ctx.ellipse(x, y, halfW * 0.9, halfH, 0, 0, Math.PI * 2);
            ctx.fill();

            // Shirt
            ctx.fillStyle = '#d64545';
            ctx.beginPath();
            ctx.ellipse(x, y + halfH * 0.05, halfW * 0.9, halfH * 0.7, 0, 0, Math.PI * 2);
            ctx.fill();

            // Head
            const headR = halfH * 0.95;
            const headY = y - halfH - headR * 0.15;
            ctx.fillStyle = '#f7c948';
            ctx.beginPath();
            ctx.arc(x - 3, headY, headR, 0, Math.PI * 2);
            ctx.fill();

            // Ears
            const earOffsetX = headR * 0.7;
            ctx.beginPath();
            ctx.arc(x - earOffsetX - 3, headY - headR * 0.2, headR * 0.35, 0, Math.PI * 2);
            ctx.arc(x + earOffsetX - 3, headY - headR * 0.2, headR * 0.35, 0, Math.PI * 2);
            ctx.fill();

            // Face details
            ctx.fillStyle = '#5d4037';
            ctx.beginPath();
            ctx.arc(x - headR * 0.35 - 3, headY - headR * 0.1, headR * 0.12, 0, Math.PI * 2);
            ctx.arc(x + headR * 0.05 - 3, headY - headR * 0.1, headR * 0.12, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath();
            ctx.arc(x - 3, headY + headR * 0.12, headR * 0.14, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = '#5d4037';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x - 3, headY + headR * 0.32, headR * 0.25, 0.1 * Math.PI, 0.9 * Math.PI);
            ctx.stroke();

            // Arms holding barrel
            const armY = y + 2;
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#f7c948';
            ctx.beginPath();
            ctx.moveTo(x - halfW * 0.5, armY);
            ctx.lineTo(x + halfW * 0.3, armY - 4);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(x - halfW * 0.2, armY + 6);
            ctx.lineTo(x + halfW * 0.4, armY + 3);
            ctx.stroke();

            // Barrel
            const barrelWidth  = halfW * 0.9;
            const barrelHeight = halfH * 0.9;
            const barrelX = x + halfW * 0.15;
            const barrelY = y - 4;

            ctx.fillStyle = '#8d6e63';
            ctx.beginPath();
            ctx.ellipse(barrelX, barrelY, barrelWidth / 2, barrelHeight / 2, 0, 0, Math.PI * 2);
            ctx.fill();

            // Barrel top
            ctx.fillStyle = '#ffeb90';
            ctx.beginPath();
            ctx.ellipse(barrelX, barrelY - barrelHeight * 0.4, barrelWidth * 0.8 / 2, barrelHeight * 0.45 / 2, 0, 0, Math.PI * 2);
            ctx.fill();

            // Barrel rim lines
            ctx.strokeStyle = '#5d4037';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(barrelX, barrelY, barrelWidth / 2, barrelHeight / 2, 0, 0, Math.PI * 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.ellipse(barrelX, barrelY - barrelHeight * 0.35, barrelWidth * 0.75 / 2, barrelHeight * 0.35 / 2, 0, 0, Math.PI * 2);
            ctx.stroke();

            // Barrel label
            ctx.fillStyle = '#fffbdd';
            ctx.font = 'bold 10px "Nunito"';
            ctx.textAlign = 'center';
            ctx.fillText('HONEY', barrelX, barrelY + 3);
        }

        drawDrop(entity) {
            const ctx = this.ctx;
            const r = entity.radius;

            // Outer glow
            ctx.save();
            ctx.shadowColor = entity.isGolden ? 'rgba(255,193,7,0.8)' : 'rgba(255,215,64,0.7)';
            ctx.shadowBlur = 12;

            ctx.beginPath();
            ctx.moveTo(entity.x, entity.y - r);
            ctx.quadraticCurveTo(entity.x + r, entity.y, entity.x, entity.y + r);
            ctx.quadraticCurveTo(entity.x - r, entity.y, entity.x, entity.y - r);
            ctx.closePath();
            ctx.fillStyle = entity.isGolden ? '#ffd600' : '#ffec80';
            ctx.fill();

            ctx.restore();

            // highlight
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath();
            ctx.ellipse(entity.x - r * 0.3, entity.y - r * 0.4, r * 0.25, r * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        drawBee(entity) {
            const ctx = this.ctx;
            const r = entity.radius;

            // Wing
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.beginPath();
            ctx.ellipse(entity.x - r * 0.1, entity.y - r * 0.7, r * 0.5, r * 0.3, -0.3, 0, Math.PI * 2);
            ctx.ellipse(entity.x + r * 0.1, entity.y - r * 0.7, r * 0.5, r * 0.3, 0.3, 0, Math.PI * 2);
            ctx.fill();

            // Body
            ctx.beginPath();
            ctx.ellipse(entity.x, entity.y, r * 0.9, r * 0.6, 0, 0, Math.PI * 2);
            ctx.fillStyle = '#ffeb3b';
            ctx.fill();

            // Stripes
            ctx.fillStyle = '#424242';
            ctx.beginPath();
            ctx.ellipse(entity.x - r * 0.25, entity.y, r * 0.15, r * 0.6, 0, 0, Math.PI * 2);
            ctx.ellipse(entity.x + r * 0.05, entity.y, r * 0.15, r * 0.6, 0, 0, Math.PI * 2);
            ctx.fill();

            // Head
            ctx.beginPath();
            ctx.arc(entity.x + r * 0.7, entity.y - r * 0.1, r * 0.35, 0, Math.PI * 2);
            ctx.fillStyle = '#424242';
            ctx.fill();

            // Eye
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(entity.x + r * 0.82, entity.y - r * 0.18, r * 0.12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#212121';
            ctx.beginPath();
            ctx.arc(entity.x + r * 0.84, entity.y - r * 0.18, r * 0.07, 0, Math.PI * 2);
            ctx.fill();
        }

        drawEntities() {
            for (let i = 0; i < this.entities.length; i++) {
                const e = this.entities[i];
                // small shadow
                this.ctx.fillStyle = 'rgba(62,39,35,0.25)';
                this.ctx.beginPath();
                this.ctx.ellipse(e.x, e.y + e.radius * 0.9, e.radius * 0.9, e.radius * 0.3, 0, 0, Math.PI * 2);
                this.ctx.fill();

                if (e.type === 'drop') {
                    this.drawDrop(e);
                } else {
                    this.drawBee(e);
                }
            }
        }

        drawPopups() {
            const ctx = this.ctx;
            for (let i = 0; i < this.popups.length; i++) {
                const p = this.popups[i];
                ctx.save();
                ctx.globalAlpha = p.opacity;
                ctx.fillStyle = p.bad ? '#d32f2f' : (p.golden ? '#ff6f00' : '#5d4037');
                ctx.font = 'bold 16px "Nunito"';
                ctx.textAlign = 'center';
                ctx.fillText(p.text, p.x, p.y);
                ctx.restore();
            }
        }

        drawIdleScreen() {
            this.drawBackground();
            this.player.x = this.width / 2;
            this.player.y = this.height - 52;
            this.drawPoohWithBarrel();

            const ctx = this.ctx;
            ctx.fillStyle = '#5d4037';
            ctx.font = 'bold 18px "Schoolbell"';
            ctx.textAlign = 'center';
            ctx.fillText('Help Pooh catch honeybee drops.', this.width / 2, 44);

            ctx.font = '14px "Nunito"';
            ctx.fillStyle = '#6d4c41';
            ctx.fillText('Tap Start, then drag to move Pooh.', this.width / 2, 64);
        }

        draw() {
            this.drawBackground();
            this.drawPoohWithBarrel();
            this.drawEntities();
            this.drawPopups();

            if (this.beeHitTimer > 0) {
                const alpha = Math.min(0.4, this.beeHitTimer * 1.3);
                this.ctx.fillStyle = 'rgba(214, 69, 69,' + alpha.toFixed(2) + ')';
                this.ctx.fillRect(0, 0, this.width, this.height);
            }
        }
    }

    window.addEventListener('DOMContentLoaded', function () {
        window.poohHoneyBarrel = new PoohHoneyBarrelGame();
    });
})();
</script>
</body>
</html>